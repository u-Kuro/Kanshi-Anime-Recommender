let db,windowHREF;self.addEventListener("unhandledrejection",event=>{console.error(event?.reason);self.postMessage({error:event?.reason||"Something went wrong"})});self.onmessage=async({data})=>{if(!windowHREF){windowHREF=data?.windowHREF}if(!db)await IDBinit();let tagInfo=await retrieveJSON("tagInfo");let tagInfoUpdateAt=await retrieveJSON("tagInfoUpdateAt");if(tagInfoUpdateAt>0&&hasTagInfoData(tagInfo)){let nextSeasonUpdateAt=tagInfoUpdateAt*1e3+7884e6;if(!nextSeasonUpdateAt||nextSeasonUpdateAt<(new Date).getTime()){getTagInfoData()}else{self.postMessage({done:true})}}else{getTagInfoData()}};async function getTagInfoData(tagInfo){try{const response=await fetch("https://graphql.anilist.co",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:`{MediaTagCollection{name category description}}`})});const result=await response?.json?.();const mediaTagCollection=result?.data?.MediaTagCollection||[];for(let i=0,l=mediaTagCollection?.length;i<l;i++){const tagCollected=mediaTagCollection?.[i];const description=tagCollected?.description;let category=tagCollected?.category;let tag=tagCollected?.name;if(!tag||!category)continue;category=cleanText(category);tag=cleanText(tag);if(!isJsonObject(tagInfo)){tagInfo={};tagInfo[category]={}}else if(!isJsonObject(tagInfo?.[category])){tagInfo[category]={}}if(description&&typeof description==="string"){tagInfo[category][tag]=description}}if(isJsonObject(tagInfo)&&!jsonIsEmpty(tagInfo)){await saveJSON(tagInfo,"tagInfo");let tagInfoUpdateAt=parseInt((new Date).getTime()/1e3);await saveJSON(tagInfoUpdateAt,"tagInfoUpdateAt")}self.postMessage({done:true})}catch{if(!await isConnected()){self.postMessage({done:true})}else{setTimeout(()=>getTagInfoData(),6e4)}}}function hasTagInfoData(tagInfo){for(let category in tagInfo){for(let tag in tagInfo[category]){return typeof tagInfo[category][tag]==="string"}return false}return false}async function IDBinit(){return await new Promise(resolve=>{let request=indexedDB.open("Kanshi.Anime.Recommendations.Anilist.W~uPtWCq=vG$TR:Zl^#t<vdS]I~N70",1);request.onerror=error=>{console.error(error)};request.onsuccess=event=>{db=event.target.result;return resolve()};request.onupgradeneeded=event=>{db=event.target.result;db.createObjectStore("MyObjectStore");let transaction=event.target.transaction;transaction.oncomplete=()=>{return resolve()}}})}async function saveJSON(data,name){return await new Promise(async(resolve,reject)=>{try{let write=db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").openCursor();write.onsuccess=async event=>{let put=await db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").put(data,name);put.onsuccess=event=>{return resolve()};put.onerror=event=>{return resolve()}};write.onerror=async error=>{console.error(error);return reject()}}catch(ex){console.error(ex)}})}async function retrieveJSON(name){return await new Promise(resolve=>{try{let read=db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").get(name);read.onsuccess=()=>{return resolve(read.result)};read.onerror=error=>{console.error(error);return resolve()}}catch(ex){console.error(ex);return resolve()}})}function isJsonObject(obj){return Object.prototype.toString.call(obj)==="[object Object]"}function jsonIsEmpty(obj){for(const key in obj)return false;return true}function cleanText(k){k=k!=="_"?k?.replace?.(/\_/g," "):k;k=k!=='\\"'?k?.replace?.(/\\"/g,'"'):k;k=k?.replace?.(/\b(tv|ona|ova)\b/gi,match=>match?.toUpperCase?.());return k?.toLowerCase?.()||""}let isConnectedPromise;async function isConnected(){if(isConnectedPromise)return isConnectedPromise;isConnectedPromise=new Promise(async resolve=>{try{if(navigator?.onLine!==false){let href=windowHREF||"https://u-kuro.github.io/Kanshi-Anime-Recommender";let response=await fetch(href,{method:"HEAD",cache:"no-store"});isConnectedPromise=null;resolve(response?.ok)}isConnectedPromise=null;resolve(false)}catch(error){isConnectedPromise=null;resolve(false)}});return isConnectedPromise}