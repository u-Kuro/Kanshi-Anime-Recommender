let db,server,connected,isShowingProgress,isShowingProgressTimeout;self.addEventListener("unhandledrejection",event=>{const reason=event?.reason;console.error(reason);let error=reason?.stack||reason?.message;if(typeof error!=="string"||!error){error="Something went wrong"}self.postMessage({error:error})});self.onmessage=async({data})=>{if(data?.connected!=null){connected=data?.connected;return}if(server==null&&data?.server!=null){server=data.server}if(!db)await IDBinit();const savedUsername=(await retrieveJSON("userData"))?.username;const userMediaUpdateAt=await retrieveJSON("userMediaUpdateAt");const username=data?.username;if(typeof username==="string"&&username!==savedUsername){getUserEntries(username,true)}else if(typeof savedUsername==="string"&&data?.reload){getUserEntries(savedUsername)}else if(typeof savedUsername==="string"){recallUE(savedUsername)}else{self.postMessage({message:"No Anilist Username Found"})}function recallUE(username){if(typeof userMediaUpdateAt==="number"&&!isNaN(userMediaUpdateAt)&&isFinite(userMediaUpdateAt)&&userMediaUpdateAt<=Number.MAX_SAFE_INTEGER){if(!data?.visibilityChange){self.postMessage({status:"Checking Latest User Entries"})}fetch("https://graphql.anilist.co",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Cache-Control":"max-age=31536000, immutable"},body:JSON.stringify({query:`{User(name:"${username}"){updatedAt}}`})}).then(async response=>{return await response.json()}).then(result=>{let error;if(typeof(error=result?.errors?.[0]?.message)==="string"){error=error||"Failed to check latest user entries";self.postMessage({status:error});self.postMessage({error:error})}else{const currentUserMediaUpdateAt=result?.data?.User?.updatedAt;if(typeof currentUserMediaUpdateAt==="number"&&!isNaN(currentUserMediaUpdateAt)&&isFinite(currentUserMediaUpdateAt)&&currentUserMediaUpdateAt<=Number.MAX_SAFE_INTEGER){if(currentUserMediaUpdateAt!==userMediaUpdateAt){self.postMessage({status:"Found latest User Entries"});getUserEntries(username)}else{self.postMessage({status:null});self.postMessage({message:"User Entries is Up to Date"})}}else{self.postMessage({status:"Invalid Response from the server"});self.postMessage({error:"Invalid Response from the server"})}}}).catch(async error=>{if(!await isConnected()){self.postMessage({status:"Server unreachable"});self.postMessage({error:"Server unreachable"});return}const errorText=error.message;if(errorText==="User not found"||errorText==="Private User"){self.postMessage({status:errorText});self.postMessage({error:errorText})}else{if(error?.headers?.get("x-ratelimit-remaining")>0){return recallUE(username)}else{let secondsPassed=60;let rateLimitInterval=setInterval(()=>{self.postMessage({status:`Rate Limit: ${msToTime(secondsPassed*1e3)}`});--secondsPassed},1e3);setTimeout(()=>{clearInterval(rateLimitInterval);self.postMessage({status:"Retrying"});return recallUE(username)},6e4)}}console.error(error)})}else{getUserEntries(username)}}function getUserEntries(username,isNewUser){let userEntries=[];let maxMediaPerChunk=500;let currentUserMediaUpdate;self.postMessage({status:"Getting User Entries"});function recallAV(chunk){fetch("https://graphql.anilist.co",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Cache-Control":"max-age=31536000, immutable"},body:JSON.stringify({query:`{MediaListCollection(userName:"${username}",${chunk>1?"chunk:"+chunk+",perChunk:"+maxMediaPerChunk+",":""}forceSingleCompletedList:true,type:ANIME){hasNextChunk lists{entries{status media{id}score progress}}user{updatedAt}}m:MediaListCollection(userName:"${username}",${chunk>1?"chunk:"+chunk+",perChunk:"+maxMediaPerChunk+",":""}forceSingleCompletedList:true,type:MANGA){hasNextChunk lists{entries{status media{id}score progress progressVolumes}}user{updatedAt}}}`})}).then(async response=>{return{headers:response.headers,result:await response.json()}}).then(async({result,headers})=>{let error;if(typeof(error=result?.errors?.[0]?.message)==="string"){error=error||"Failed to retrieve entries.";self.postMessage({status:error});self.postMessage({error:error})}else{const animeCollection=result?.data?.MediaListCollection;const mangaCollection=result?.data?.m;const newUserMediaAnimeUpdate=animeCollection?.user?.updatedAt;if(typeof newUserMediaAnimeUpdate==="number"&&!isNaN(newUserMediaAnimeUpdate)&&isFinite(newUserMediaAnimeUpdate)&&newUserMediaAnimeUpdate<=Number.MAX_SAFE_INTEGER){if(newUserMediaAnimeUpdate>currentUserMediaUpdate||typeof currentUserMediaUpdate!=="number"||isNaN(currentUserMediaUpdate)||!isFinite(currentUserMediaUpdate)||!(currentUserMediaUpdate<=Number.MAX_SAFE_INTEGER)){currentUserMediaUpdate=newUserMediaAnimeUpdate}}const newUserMediaMangaUpdate=mangaCollection?.user?.updatedAt;if(typeof newUserMediaMangaUpdate==="number"&&!isNaN(newUserMediaMangaUpdate)&&isFinite(newUserMediaMangaUpdate)&&newUserMediaMangaUpdate<=Number.MAX_SAFE_INTEGER){if(newUserMediaMangaUpdate>currentUserMediaUpdate||typeof currentUserMediaUpdate!=="number"||isNaN(currentUserMediaUpdate)||!isFinite(currentUserMediaUpdate)||!(currentUserMediaUpdate<=Number.MAX_SAFE_INTEGER)){currentUserMediaUpdate=newUserMediaMangaUpdate}}let userList=[];if(animeCollection?.lists instanceof Array){userList=animeCollection.lists}if(mangaCollection?.lists instanceof Array){userList=userList.concat(mangaCollection.lists)}for(let i=0;i<userList.length;i++){if(userList[i]?.entries instanceof Array){userEntries=userEntries.concat(userList[i].entries)}}const hasNextChunk=animeCollection?.hasNextChunk||mangaCollection?.hasNextChunk;if(hasNextChunk&&(userList?.length??0)>0){if(!isShowingProgress){isShowingProgress=true;isShowingProgressTimeout=setTimeout(()=>{self.postMessage({status:`${userEntries.length} User ${userEntries.length>1?"Entries":"Entry"} has been added`});isShowingProgress=false},17)}if(headers?.get("x-ratelimit-remaining")>0){return recallAV(++chunk)}else{let secondsPassed=60;let rateLimitInterval=setInterval(()=>{self.postMessage({status:`Rate Limit: ${msToTime(secondsPassed*1e3)}`});--secondsPassed},1e3);setTimeout(()=>{clearInterval(rateLimitInterval);self.postMessage({status:"Retrying"});return recallAV(++chunk)},6e4)}}else{clearTimeout(isShowingProgressTimeout);isShowingProgress=false;self.postMessage({status:`${userEntries.length} User ${userEntries.length>1?"Entries":"Entry"} has been added`});isShowingProgress=false;const mediaEntries=await retrieveJSON("mediaEntries");const collectionToPut={shouldProcessRecommendation:true,userData:{username:username,userEntries:userEntries.reduce((result,entry)=>{const userMediaID=entry?.media?.id;const userEntry={};if(userMediaID&&mediaEntries[userMediaID]){userEntry.media=mediaEntries[userMediaID];userEntry.status=entry?.status;userEntry.score=entry?.score;userEntry.progress=entry?.progress;userEntry.progressVolumes=entry?.progressVolumes;result.push(userEntry)}return result},[])}};if(typeof currentUserMediaUpdate==="number"&&!isNaN(currentUserMediaUpdate)&&isFinite(currentUserMediaUpdate)&&currentUserMediaUpdate<=Number.MAX_SAFE_INTEGER){collectionToPut.userMediaUpdateAt=currentUserMediaUpdate}else if(isNewUser){collectionToPut.userMediaUpdateAt=0}await saveJSONCollection(collectionToPut);self.postMessage({status:null});self.postMessage({updateRecommendationList:true});self.postMessage({newusername:username})}}}).catch(async error=>{clearTimeout(isShowingProgressTimeout);isShowingProgress=false;if(!await isConnected()){self.postMessage({status:"Server unreachable"});self.postMessage({error:"Server unreachable"});return}const errorText=error.message;if(errorText==="User not found"||errorText==="Private User"){self.postMessage({status:errorText});self.postMessage({error:errorText})}else{if(error?.headers?.get("x-ratelimit-remaining")>0){return recallAV(chunk)}else{let secondsPassed=60;let rateLimitInterval=setInterval(()=>{self.postMessage({status:`Rate Limit: ${msToTime(secondsPassed*1e3)}`});--secondsPassed},1e3);setTimeout(()=>{clearInterval(rateLimitInterval);self.postMessage({status:"Retrying"});return recallAV(chunk)},6e4)}}console.error(error)})}recallAV(1)}};function IDBinit(){return new Promise(resolve=>{let request=indexedDB.open("Kanshi.Media.Recommendations.Anilist.W~uPtWCq=vG$TR:Zl^#t<vdS]I~N70",1);request.onsuccess=event=>{db=event.target.result;resolve()};request.onupgradeneeded=event=>{db=event.target.result;db.createObjectStore("others");event.target.transaction.oncomplete=()=>{resolve()}};request.onerror=error=>{console.error(error)}})}function retrieveJSON(name){return new Promise(resolve=>{try{let get=db.transaction("others","readonly").objectStore("others").get(name);get.onsuccess=()=>{let result=get.result;if(result instanceof Blob){result=JSON.parse((new FileReaderSync).readAsText(result))}else if(result instanceof ArrayBuffer){result=JSON.parse((new TextDecoder).decode(result))}resolve(result)};get.onerror=ex=>{console.error(ex);resolve()}}catch(ex){console.error(ex);resolve()}})}function saveJSONCollection(collection){return new Promise((resolve,reject)=>{try{let transaction=db.transaction("others","readwrite");let store=transaction.objectStore("others");let put;transaction.oncomplete=()=>{resolve()};for(let key in collection){let data=collection[key];let blob;if(data instanceof Blob){blob=data;put=store.put(blob,key)}else if(isJsonObject(data)||data instanceof Array){blob=new Blob([JSON.stringify(data)]);put=store.put(blob,key)}else{put=store.put(data,key)}put.onerror=ex=>{transaction.oncomplete=undefined;if(blob instanceof Blob){try{transaction.oncomplete=()=>{resolve()};put=store.put((new FileReaderSync).readAsArrayBuffer(blob),key);put.onerror=ex=>{console.error(ex);reject(ex)};try{transaction?.commit?.()}catch{}}catch(ex2){console.error(ex);console.error(ex2);reject(ex2)}}else{console.error(ex);reject(ex)}}}try{transaction?.commit?.()}catch{}}catch(ex){console.error(ex);reject(ex)}})}function isJsonObject(obj){return Object.prototype.toString.call(obj)==="[object Object]"}function msToTime(duration,limit){try{if(duration<1e3){return"0s"}let seconds=Math.floor(duration/1e3%60),minutes=Math.floor(duration/6e4%60),hours=Math.floor(duration/36e5%24),days=Math.floor(duration/864e5%7),weeks=Math.floor(duration/6048e5%4),months=Math.floor(duration/24192e5%12),years=Math.floor(duration/290304e5%10),decades=Math.floor(duration/290304e6%10),century=Math.floor(duration/290304e7%10),millenium=Math.floor(duration/290304e8%10);let time=[];if(millenium>0)time.push(`${millenium}mil`);if(century>0)time.push(`${century}cen`);if(decades>0)time.push(`${decades}dec`);if(years>0)time.push(`${years}y`);if(months>0)time.push(`${months}mon`);if(weeks>0)time.push(`${weeks}w`);if(days>0)time.push(`${days}d`);if(hours>0)time.push(`${hours}h`);if(minutes>0)time.push(`${minutes}m`);if(seconds>0)time.push(`${seconds}s`);if(limit>0){time=time.slice(0,limit)}return time.join(" ")||"0s"}catch(e){return""}}function isConnected(url=server){if(typeof url!=="string"||url===""){const $connected=connected;if(typeof $connected==="boolean"){connected=null;return $connected}else{self.postMessage({getConnectionState:true});return true}}else{return new Promise(async resolve=>{if(await checkConnection(url))return resolve(true);else await new Promise(r=>setTimeout(r,5e3));return resolve(await checkConnection(url))})}}async function checkConnection(url){try{if(navigator?.onLine!==false){const response=await fetch(url,{method:"HEAD",cache:"no-store"});return response?.ok}}catch{}return false}