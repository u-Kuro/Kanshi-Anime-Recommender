let db,userList,recommendedMediaList,semiContentCautions={genres:{},tags:{}},cautionContents={genres:{},tags:{}},loadedIds={},loadedIndices={},loadMediaTimeout={},lastSearchedWord={},shouldUpdateUserList,shouldUpdateRecommendedMediaList,shouldUpdateMediaCautions,updateListTimeout,selectCategoryTimeout,messageQueue=[],isProcessing,latestUpdateDate,latestSearchDate={};const createKSVG=(classes="")=>`<svg class="general-rating-icon ${classes}" viewBox="0 0 320 512"><path d="M311 86a32 32 0 1 0-46-44L110 202l-46 47V64a32 32 0 1 0-64 0v384a32 32 0 1 0 64 0V341l65-67 133 192c10 15 30 18 44 8s18-30 8-44L174 227 311 86z"/></svg>`;const hasOwnProperty=Object.prototype.hasOwnProperty;self.addEventListener("unhandledrejection",event=>{const reason=event?.reason;console.error(reason);let error=reason?.stack||reason?.message;if(typeof error!=="string"||!error){error="Something went wrong"}self.postMessage({error:error})});self.onmessage=({data})=>{messageQueue.push(data);if(!isProcessing){isProcessing=true;executeMessage()}};async function executeMessage(){const data=messageQueue.shift();const postId=data?.postId;try{if(!db)await IDBinit();if(hasOwnProperty.call(data,"loadMore")){let selectedCategory=data?.selectedCategory;if(recommendedMediaList!=null&&userList!=null&&selectedCategory!=null){const searchDate=data?.searchDate;if(searchDate>latestSearchDate[selectedCategory]||latestSearchDate[selectedCategory]==null&&searchDate){latestSearchDate[selectedCategory]=searchDate}clearTimeout(loadMediaTimeout[selectedCategory]);loadMediaTimeout[selectedCategory]=setTimeout(()=>{let categories=userList?.categories;let category=categories?.[selectedCategory];if(category!=null){let{mediaList,shownSortName}=category;const searchedWord=data?.searchedWord;const shouldReload=data?.reload||searchedWord!==lastSearchedWord[selectedCategory];lastSearchedWord[selectedCategory]=searchedWord;let idx=shouldReload?0:loadedIndices[selectedCategory]??0;loadedIndices[selectedCategory]=idx+1;let mediaListLen=mediaList.length;if(typeof searchedWord==="string"){const query=searchedWord.trim().replace(/[\uFF01-\uFF60\uFFE0-\uFFE6\u3000]/g,ch=>{if(ch==="　")return"";return String.fromCharCode(ch.charCodeAt(0)-65248)}).normalize("NFD").replace(/[^a-zA-Z0-9\p{Lo}]/gu,"").toLowerCase();mediaList=mediaList.filter(id=>{let title=recommendedMediaList[id]?.title;if(isJsonObject(title)){return Object.values(title).some($title=>typeof $title==="string"&&$title.trim().replace(/[\uFF01-\uFF60\uFFE0-\uFFE6\u3000]/g,ch=>{if(ch==="　")return"";return String.fromCharCode(ch.charCodeAt(0)-65248)}).normalize("NFD").replace(/[^a-zA-Z0-9\p{Lo}]/gu,"").toLowerCase().includes(query))}});mediaListLen=mediaList.length}if(idx<mediaListLen||mediaListLen===0){let id=mediaList[idx];let media=editMedia(recommendedMediaList[id],shownSortName);let airingAt=media?.nextAiringEpisode?.airingAt;self.postMessage({loadMore:true,selectedCategory:selectedCategory,idx:idx,media:media,airingAt:airingAt*1e3>(new Date).getTime()?airingAt:undefined,isLast:idx+1>=mediaListLen,updateDate:latestUpdateDate,searchDate:latestSearchDate[selectedCategory]});loadedIds[selectedCategory]=mediaList.slice(0,idx).map(id=>id)}}},0)}}else if(hasOwnProperty.call(data,"categorySelected")){let categorySelected=data?.categorySelected;if(userList!=null&&categorySelected!=null){let categories=userList?.categories;let category=categories?.[categorySelected];if(category!=null){const{mediaFilters,sortBy}=category;self.postMessage({categorySelected:categorySelected,category:{mediaFilters:mediaFilters,sortBy:sortBy},reloadList:true,postId:postId})}}}else if(hasOwnProperty.call(data,"getEarlisetReleaseDate")){if(recommendedMediaList!=null){let loadedListsArrays=Object.values(loadedIds);let flattenedLoadedList=loadedListsArrays.reduce((acc,curr)=>{for(let i=0,l=curr?.length;i<l;i++){acc.push(curr[i])}return acc},[]);let loadedList=flattenedLoadedList.map(id=>recommendedMediaList[id]);if(loadedList.length){const currentDate=new Date;loadedList=loadedList.filter(e=>e?.nextAiringEpisode?.airingAt*1e3>currentDate);if(loadedList.length){loadedList.sort((a,b)=>{let x=a?.nextAiringEpisode?.airingAt,y=b?.nextAiringEpisode?.airingAt;x=x!=null?x:Infinity;y=y!=null?y:Infinity;return x-y});let earliestReleaseDate=loadedList?.[0]?.nextAiringEpisode?.airingAt;if(typeof earliestReleaseDate==="number"&&!isNaN(earliestReleaseDate)){self.postMessage({getEarlisetReleaseDate:true,earliestReleaseDate:earliestReleaseDate})}}}}}else if(hasOwnProperty.call(data,"loadAll")){userList=await retrieveJSON("userList");if(!isJsonObject(userList)||jsonIsEmpty(userList)){userList=null;self.postMessage({loadAll:true,shouldReloadList:true,updateDate:latestUpdateDate,postId:postId})}else{let selectedCategory=data.selectedCategory;let{hiddenEntries,mediaCautions}=userList;let categories=userList?.categories||{};let category=categories?.[selectedCategory];if(category==null){for(let categoriesKey in categories){selectedCategory=categoriesKey;category=categories[selectedCategory];break}}const{mediaFilters,sortBy}=category||{};self.postMessage({loadAll:true,shouldReloadList:false,categories:Object.keys(categories||{}).sort().reduce((acc,rec)=>{acc[rec]=1;return acc},{}),hiddenEntries:hiddenEntries,mediaCautions:mediaCautions,selectedCategory:selectedCategory,category:{mediaFilters:mediaFilters,sortBy:sortBy},reloadList:true,updateDate:latestUpdateDate,postId:postId});for(let i=0,l=mediaCautions?.length;i<l;i++){let{status,filterType,optionName,optionCategory}=mediaCautions[i]||{};if(status==="included"){if(filterType==="selection"){if(optionCategory==="genre"){semiContentCautions.genres[optionName]=true}else if(optionCategory==="tag"){semiContentCautions.tags[optionName]=true}}}else if(status==="excluded"){if(filterType==="selection"){if(optionCategory==="genre"){cautionContents.genres[optionName]=true}else if(optionCategory==="tag"){cautionContents.tags[optionName]=true}}}}recommendedMediaList=await retrieveJSON("recommendedMediaList")}}else{shouldUpdateUserList=shouldUpdateUserList||hasOwnProperty.call(data,"updateUserList");shouldUpdateRecommendedMediaList=shouldUpdateRecommendedMediaList||hasOwnProperty.call(data,"updateRecommendedMediaList");shouldUpdateMediaCautions=shouldUpdateMediaCautions||hasOwnProperty.call(data,"updateMediaCautions");const updateList=(updateDate,updatedCategories)=>{let promises=[];if(shouldUpdateRecommendedMediaList){promises.push((async()=>{recommendedMediaList=await retrieveJSON("recommendedMediaList")||recommendedMediaList;shouldUpdateRecommendedMediaList=false})())}if(shouldUpdateMediaCautions){promises.push((async()=>{userList=await retrieveJSON("userList")||userList;let mediaCautions=userList?.mediaCautions;if(mediaCautions instanceof Array){semiContentCautions={genres:{},tags:{}};cautionContents={genres:{},tags:{}};for(let i=0,l=mediaCautions?.length;i<l;i++){let{status,filterType,optionName,optionCategory}=mediaCautions[i]||{};if(status==="included"){if(filterType==="selection"){if(optionCategory==="genre"){semiContentCautions.genres[optionName]=true}else if(optionCategory==="tag"){semiContentCautions.tags[optionName]=true}}}else if(status==="excluded"){if(filterType==="selection"){if(optionCategory==="genre"){cautionContents.genres[optionName]=true}else if(optionCategory==="tag"){cautionContents.tags[optionName]=true}}}}}shouldUpdateUserList=shouldUpdateMediaCautions=false})())}else if(shouldUpdateUserList||updatedCategories){promises.push((async()=>{userList=await retrieveJSON("userList")||userList;shouldUpdateUserList=false})())}Promise.all(promises).then(()=>{if(updatedCategories){const categories=userList?.categories||{};for(const categoryKey in updatedCategories){const category=categories[categoryKey];if(category==null)continue;const{mediaFilters,sortBy}=category;updatedCategories[categoryKey]={mediaFilters:mediaFilters,sortBy:sortBy}}if(updateDate>latestUpdateDate||latestUpdateDate==null&&updateDate){latestUpdateDate=updateDate}self.postMessage({updateDate:updateDate,updatedCategories:updatedCategories,categories:Object.keys(categories||{}).sort().reduce((acc,rec)=>{acc[rec]=1;return acc},{}),reloadList:true,updateDate:updateDate,postId:postId})}else{if(updateDate>latestUpdateDate||latestUpdateDate==null&&updateDate){latestUpdateDate=updateDate}self.postMessage({reloadList:true,updateDate:updateDate,postId:postId})}})};const updateDate=data.updateDate;if(updateDate>latestUpdateDate||latestUpdateDate==null&&updateDate){clearTimeout(updateListTimeout)}if(hasOwnProperty.call(data,"updatedCategories")){updateList(updateDate,data.updatedCategories)}else{updateListTimeout=setTimeout(()=>updateList(updateDate))}}}catch(reason){console.error(reason);let error=reason?.stack||reason?.message;if(typeof error!=="string"||!error){error="Something went wrong"}self.postMessage({error:error,postId:postId})}if(messageQueue.length>0){executeMessage()}else{isProcessing=false}}function editMedia(media,shownSortName){if(media==null)return null;media=JSON.parse(JSON.stringify(media));if(hasOwnProperty.call(media,"isEdited")){return media}media.contentCaution={caution:[],semiCaution:[]};media.genres.forEach(genre=>{if(cautionContents.genres[genre]){media.contentCaution.caution.push(genre)}else if(semiContentCautions.genres[genre]){media.contentCaution.semiCaution.push(genre)}});media.tags.forEach(tag=>{let tagName=tag?.name;if(cautionContents.tags[tagName]){media.contentCaution.caution.push(tagName)}else if(semiContentCautions.tags[tagName]){media.contentCaution.semiCaution.push(tagName)}});if(isJsonObject(media.favoriteContents)&&!jsonIsEmpty(media.favoriteContents)){let sortedFavoriteContents=Object.entries(media.favoriteContents.genres).concat(Object.entries(media.favoriteContents.tags)).concat(Object.entries(media.favoriteContents.studios)).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}: (${formatNumber(v)})`);media.sortedFavoriteContents=sortedFavoriteContents||[]}else{media.sortedFavoriteContents=[]}let genres=media?.genres;if(genres?.length){let favouriteGenres=media?.favoriteContents?.genres||{},otherGenres=media?.otherContents?.genres||{},contentCaution=media?.contentCaution,caution={},semiCaution={};if(isJsonObject(contentCaution)&&!jsonIsEmpty(contentCaution)){contentCaution?.caution.forEach(genre=>{caution[genre]=true});contentCaution?.semiCaution.forEach(genre=>{semiCaution[genre]=true})}let genresFavourite=[],genreCaution=[],genreSemiCaution=[],genresOthers=[],others=[],genresRunnned={};genres.forEach(genre=>{if(genresRunnned[genre]||!genre)return;genresRunnned[genre]=true;if(caution[genre]){if(favouriteGenres[genre]>0){genre=`${genre} (${formatNumber(favouriteGenres[genre])})`}else if(otherGenres[genre]>0){genre=`${genre} (${formatNumber(otherGenres[genre])})`}genreCaution.push({genre:genre,genreColor:"red"})}else if(semiCaution[genre]){if(favouriteGenres[genre]>0){genre=`${genre} (${formatNumber(favouriteGenres[genre])})`}else if(otherGenres[genre]>0){genre=`${genre} (${formatNumber(otherGenres[genre])})`}genreSemiCaution.push({genre:genre,genreColor:"teal"})}else if(favouriteGenres[genre]){genresFavourite.push({genre:genre,score:favouriteGenres[genre]})}else if(favouriteGenres[genre]>0){genresFavourite.push({genre:genre,score:favouriteGenres[genre]})}else if(otherGenres[genre]>0){genresOthers.push({genre:genre,score:otherGenres[genre]})}else{others.push({genre:genre,genreColor:null})}});genresFavourite.sort((a,b)=>{let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;return bScore-aScore});genresFavourite=genresFavourite.map(e=>{return{genre:`${e.genre} (${formatNumber(e.score)})`,genreColor:"green"}});genresOthers.sort((a,b)=>{let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;return bScore-aScore});genresOthers=genresOthers.map(e=>{return{genre:`${e.genre} (${formatNumber(e.score)})`,genreColor:null}});media.shownGenres=genreCaution.concat(genreSemiCaution).concat(genresFavourite).concat(genresOthers).concat(others)}else{media.shownGenres=[]}let tags=media?.tags;if(tags?.length){let favouriteTags=media?.favoriteContents?.tags||{},otherTags=media?.otherContents?.tags||{},contentCaution=media?.contentCaution,caution={},semiCaution={};if(isJsonObject(contentCaution)&&!jsonIsEmpty(contentCaution)){contentCaution?.caution.forEach(tag=>{caution[tag]=true});contentCaution?.semiCaution.forEach(tag=>{semiCaution[tag]=true})}let tagsFavourite=[],tagsOthers=[],tagCaution=[],tagSemiCaution=[],others=[];let tagsRunnned={};tags.forEach(tag=>{let tagName=tag?.name;if(tagsRunnned[tagName]||!tagName)return;tagsRunnned[tagName]=true;let tagRank=tag?.rank;if(caution[tagName]){let score;if(favouriteTags[tagName]>0){score=favouriteTags[tagName]}else if(otherTags[tagName]>0){score=otherTags[tagName]}tagCaution.push({tagName:tagName,score:score,tagRank:tagRank})}else if(semiCaution[tagName]){let score;if(favouriteTags[tagName]>0){score=favouriteTags[tagName]}else if(otherTags[tagName]>0){score=otherTags[tagName]}tagSemiCaution.push({tagName:tagName,score:score,tagRank:tagRank})}else if(favouriteTags[tagName]>0){tagsFavourite.push({tagName:tagName,score:favouriteTags[tagName],tagRank:tagRank})}else if(otherTags[tagName]>0){tagsOthers.push({tagName:tagName,score:otherTags[tagName],tagRank:tagRank})}else{others.push({tagName:tagName,tagRank:tagRank})}});tagCaution.sort((a,b)=>{let aRank=a?.tagRank,bRank=b?.tagRank;if(aRank==null||isNaN(aRank))return 1;if(bRank==null||isNaN(bRank))return-1;if(bRank!==aRank)return bRank-aRank;let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;return aScore-bScore});tagCaution=tagCaution.map(({tagName,score,tagRank})=>{let tag;if(score!=null){tag=`<span>${tagName} (${formatNumber(score)})${tagRank?"</span><span> "+tagRank+"%":""}</span>`}else{tag=`<span>${tagName}${tagRank?"</span><span> "+tagRank+"%":""}</span>`}return{tagName:tagName,tag:tag,tagColor:"red"}});tagSemiCaution.sort((a,b)=>{let aRank=a?.tagRank,bRank=b?.tagRank;if(aRank==null||isNaN(aRank))return 1;if(bRank==null||isNaN(bRank))return-1;if(bRank!==aRank)return bRank-aRank;let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;return aScore-bScore});tagSemiCaution=tagSemiCaution.map(({tagName,score,tagRank})=>{let tag;if(score!=null){tag=`<span>${tagName} (${formatNumber(score)})${tagRank?"</span><span> "+tagRank+"%":""}</span>`}else{tag=`<span>${tagName}${tagRank?"</span><span> "+tagRank+"%":""}</span>`}return{tagName:tagName,tag:tag,tagColor:"teal"}});tagsFavourite.sort((a,b)=>{let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;if(bScore!==aScore)return bScore-aScore;let aRank=a?.tagRank,bRank=b?.tagRank;if(aRank==null||isNaN(aRank))return 1;if(bRank==null||isNaN(bRank))return-1;return bRank-aRank});tagsFavourite=tagsFavourite.map(({tagName,score,tagRank})=>{return{tagName:tagName,tag:`<span>${tagName} (${formatNumber(score)})${tagRank?"</span><span> "+tagRank+"%":""}</span>`,tagColor:"green"}});tagsOthers.sort((a,b)=>{let aRank=a?.tagRank,bRank=b?.tagRank;if(aRank==null||isNaN(aRank))return 1;if(bRank==null||isNaN(bRank))return-1;if(bRank!==aRank)return bRank-aRank;let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;return bScore-aScore});tagsOthers=tagsOthers.map(({tagName,score,tagRank})=>{return{tagName:tagName,tag:`<span>${tagName} (${formatNumber(score)})${tagRank?"</span><span> "+tagRank+"%":""}</span>`,tagColor:null}});others.sort((a,b)=>{let aRank=a?.tagRank,bRank=b?.tagRank;if(aRank==null||isNaN(aRank))return 1;if(bRank==null||isNaN(bRank))return-1;return bRank-aRank});others=others.map(({tagName,tagRank})=>{return{tagName:tagName,tag:`<span>${tagName}${tagRank?"</span><span> "+tagRank+"%":""}</span>`,tagColor:null}});media.shownTags=tagCaution.concat(tagSemiCaution).concat(tagsFavourite).concat(tagsOthers).concat(others)}else{media.shownTags=[]}let studios=Object.entries(media.studios||{});if(studios?.length){let favouriteStudios=media?.favoriteContents?.studios||{},otherStudios=media?.otherContents?.studios||{},studiosFavourite=[],studiosOthers=[],others=[],studiosRunnned={};studios.forEach(([studio,studioUrl])=>{if(studiosRunnned[studio]||!studio)return;studiosRunnned[studio]=true;if(favouriteStudios[studio]>0){studiosFavourite.push({studio:[studio,studioUrl],score:favouriteStudios[studio]})}else if(otherStudios[studio]>0){studiosOthers.push({studio:[studio,studioUrl],score:otherStudios[studio]})}else{others.push({studio:{studioName:studio,studioUrl:studioUrl},studioColor:null})}});studiosFavourite.sort((a,b)=>{let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;return bScore-aScore});studiosFavourite=studiosFavourite.map(e=>{return{studio:{studioName:`${e.studio[0]} (${formatNumber(e.score)})`,studioUrl:e.studio[1]},studioColor:"green"}});studiosOthers.sort((a,b)=>{let aScore=a?.score,bScore=b?.score;if(aScore==null||isNaN(aScore))return 1;if(bScore==null||isNaN(bScore))return-1;return bScore-aScore});studiosOthers=studiosOthers.map(e=>{return{studio:{studioName:`${e.studio[0]} (${formatNumber(e.score)})`,studioUrl:e.studio[1]},studioColor:null}});media.shownStudios=studiosFavourite.concat(studiosOthers).concat(others)}else{media.shownStudios=[]}let title=media?.title;media.shownTitle=title?.english||title?.romaji||title?.native||"";media.copiedTitle=title?.romaji||title?.english||title?.native||"";let score=media?.score;let meanScoreAll=media?.meanScoreAll;let meanScoreAbove=media?.meanScoreAbove;let sortedFavoriteContents=media?.sortedFavoriteContents;let contentCaution=media?.contentCaution;let _sortedFavoriteContents=[];sortedFavoriteContents?.forEach(e=>{if(typeof e==="string"){_sortedFavoriteContents.push(e)}});let _contentCaution=[];if(score<meanScoreAll){_contentCaution.push(`Very Low Score (mean: ${formatNumber(meanScoreAll)})`)}else if(score<meanScoreAbove){_contentCaution.push(`Low Score (mean: ${formatNumber(meanScoreAbove)})`)}_contentCaution=_contentCaution.concat(contentCaution?.caution||[]).concat(contentCaution?.semiCaution||[]);let briefInfo="";if(_sortedFavoriteContents.length){briefInfo+="Favorite Contents: "+_sortedFavoriteContents.join(", ")||""}if(_contentCaution.length){briefInfo+="\n\nContent Cautions: "+_contentCaution.join(", ")}media.briefInfo=briefInfo;let userStatus=media?.userStatus;if(userStatus==="Completed"){media.userStatusColor="green"}else if(userStatus==="Current"||userStatus==="Repeating"){media.userStatusColor="blue"}else if(userStatus==="Planning"){media.userStatusColor="orange"}else if(userStatus==="Paused"){media.userStatusColor="peach"}else if(userStatus==="Dropped"){media.userStatusColor="red"}let contentCautionColor;if(contentCaution?.caution?.length){contentCautionColor="red"}else if(contentCaution?.semiCaution?.length){contentCautionColor="teal"}else if(score<meanScoreAll){contentCautionColor="purple"}else if(score<meanScoreAbove){contentCautionColor="orange"}else{contentCautionColor="green"}media.contentCautionColor=contentCautionColor;media.formattedWeightedScore=formatNumber(media?.weightedScore);media.formattedAverageScore=formatNumber(media?.averageScore*.1,1);media.formattedPopularity=formatNumber(media?.popularity,media?.popularity>=1e3?1:0);if(shownSortName==="score"||shownSortName==="date"||shownSortName==="date added"||shownSortName==="date updated"){media.shownScore=formatNumber(score)??"N/A"}else if(shownSortName==="user score"){media.shownScore=media?.userScore??"N/A"}else if(shownSortName==="average score"){media.shownScore=media?.averageScore??"N/A"}else if(shownSortName==="popularity"){media.shownCount=media.formattedPopularity??"N/A"}else if(shownSortName==="trending"){media.shownActivity=formatNumber(media?.trending,media?.trending>=1e3?1:0)??"N/A"}else if(shownSortName==="favorites"){media.shownFavorites=formatNumber(media?.favorites,media?.favorites>=1e3?1:0)??"N/A"}else{media.shownScore=media.formattedWeightedScore??"N/A"}let recommendedRatingInfo;if(score<meanScoreAll){recommendedRatingInfo=createKSVG("purple-fill")}else if(score<meanScoreAbove){recommendedRatingInfo=createKSVG("orange-fill")}else{recommendedRatingInfo=createKSVG("green-fill")}media.recommendedRatingInfo=recommendedRatingInfo;let duration=media?.duration;if(duration>0){let time=msToTime(duration*60*1e3);media.formattedDuration=` · ${time?time:""}`}media.isEdited=true;return media}function formatNumber(number,dec=2){if(typeof number==="number"){const formatter=new Intl.NumberFormat("en-US",{maximumFractionDigits:dec,minimumFractionDigits:0,notation:"compact",compactDisplay:"short"});if(Math.abs(number)>=1e3){return formatter.format(number)}else if(Math.abs(number)<.01&&Math.abs(number)>0){return number.toExponential(0)}else{let formattedNumber=number.toFixed(dec);if(formattedNumber.indexOf(".")!==-1){formattedNumber=formattedNumber.replace(/\.?0+$/,"")}return formattedNumber||number.toLocaleString("en-US",{maximumFractionDigits:dec})}}else{return null}}function msToTime(duration,limit){try{if(duration<1e3){return"0s"}let seconds=Math.floor(duration/1e3%60),minutes=Math.floor(duration/6e4%60),hours=Math.floor(duration/36e5%24),days=Math.floor(duration/864e5%7),weeks=Math.floor(duration/6048e5%4),months=Math.floor(duration/24192e5%12),years=Math.floor(duration/290304e5%10),decades=Math.floor(duration/290304e6%10),century=Math.floor(duration/290304e7%10),millenium=Math.floor(duration/290304e8%10);let time=[];if(millenium>0)time.push(`${millenium}mil`);if(century>0)time.push(`${century}cen`);if(decades>0)time.push(`${decades}dec`);if(years>0)time.push(`${years}y`);if(months>0)time.push(`${months}mon`);if(weeks>0)time.push(`${weeks}w`);if(days>0)time.push(`${days}d`);if(hours>0)time.push(`${hours}h`);if(minutes>0)time.push(`${minutes}m`);if(seconds>0)time.push(`${seconds}s`);if(limit>0){time=time.slice(0,limit)}return time.join(" ")||"0s"}catch(e){return""}}function IDBinit(){return new Promise(resolve=>{let request=indexedDB.open("Kanshi.Media.Recommendations.Anilist.W~uPtWCq=vG$TR:Zl^#t<vdS]I~N70",1);request.onsuccess=event=>{db=event.target.result;resolve()};request.onupgradeneeded=event=>{db=event.target.result;db.createObjectStore("others");event.target.transaction.oncomplete=()=>{resolve()}};request.onerror=error=>{console.error(error)}})}function retrieveJSON(name){return new Promise(resolve=>{try{let get=db.transaction("others","readonly").objectStore("others").get(name);get.onsuccess=()=>{let result=get.result;if(result instanceof Blob){result=JSON.parse((new FileReaderSync).readAsText(result))}else if(result instanceof ArrayBuffer){result=JSON.parse((new TextDecoder).decode(result))}resolve(result)};get.onerror=ex=>{console.error(ex);resolve()}}catch(ex){console.error(ex);resolve()}})}function jsonIsEmpty(obj){for(const key in obj){return false}return true}function isJsonObject(obj){return Object.prototype.toString.call(obj)==="[object Object]"}