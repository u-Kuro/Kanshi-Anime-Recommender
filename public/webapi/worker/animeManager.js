let db,userList,recommendedAnimeList,animeCautions,updateMediaFilterJobs={},updateAllMediaJob,messageQueue=[],isProcessing;const hasOwnProperty=Object.prototype.hasOwnProperty;self.addEventListener("unhandledrejection",event=>{const reason=event?.reason;console.error(reason);let error=reason?.stack||reason?.message;if(typeof error!=="string"||!error){error="Something went wrong"}self.postMessage({error:error})});self.onmessage=({data})=>{messageQueue.push(data);if(!isProcessing){isProcessing=true;executeMessage()}};async function executeMessage(){const data=messageQueue.shift();const postId=data?.postId;try{if(!db)await IDBinit();let updateRecommendedAnimeList,updateUserList;if(userList==null||!isJsonObject(userList)||jsonIsEmpty(userList)){userList=await retrieveJSON("userList")||getDefaultUserList();updateUserList=true}if(data?.updateRecommendedAnimeList!=null||recommendedAnimeList==null){recommendedAnimeList=await retrieveJSON("recommendedAnimeList");updateRecommendedAnimeList=true}if(hasOwnProperty.call(data,"selectCategory")){let selectedCategory=data?.selectCategory;if(userList!=null&&selectedCategory!=null){let categories=userList?.categories;let category=categories?.[selectedCategory];if(category==null){self.postMessage({postId:postId})}else{userList.selectedCategory=selectedCategory;await saveJSON(userList,"userList").then(()=>{self.postMessage({postId:postId})})}}else{self.postMessage({postId:postId})}}else if(hasOwnProperty.call(data,"updateAnimeFilter")){let selectedCategory=data?.selectedCategory;if(selectedCategory){clearTimeout(updateMediaFilterJobs[selectedCategory]);self.postMessage({removedPostWork:true})}updateMediaFilterJobs[selectedCategory]=setTimeout(async()=>{self.postMessage({status:"Updating Lists"});let newAnimeFilters=data?.animeFilters;let newSortBy=data?.sortBy;if(recommendedAnimeList!=null&&userList!=null&&selectedCategory!=null&&(newAnimeFilters!=null||newSortBy!=null)){let categories=userList?.categories;let category=categories?.[selectedCategory];if(category==null){self.postMessage({progress:95});self.postMessage({postId:postId})}else{let animeFilters=data?.animeFilters||category.animeFilters;let sortBy=data?.sortBy||category.sortBy;let animeCautions=userList.animeCautions;let cautions=await getContentCaution(animeCautions);let newCategory=updateAnimeList(animeFilters,sortBy,Object.values(recommendedAnimeList),userList.hiddenEntries,cautions);category.isHiddenList=newCategory.isHiddenList;category.shownSortName=newCategory.shownSortName;category.sortBy=newCategory.sortBy;category.animeFilters=newCategory.animeFilters;category.animeList=newCategory.animeList;userList.categories[selectedCategory]=category;self.postMessage({progress:85});await saveJSON(userList,"userList").then(()=>{self.postMessage({progress:95});self.postMessage({updateUserList:true,postId:postId})})}}else{self.postMessage({progress:95});self.postMessage({postId:postId})}},0)}else if(hasOwnProperty.call(data,"removeId")){self.postMessage({status:"Updating Lists"});let removedId=data?.removeId;let isHiding=data?.isHiding;if(recommendedAnimeList!=null&&userList!=null&&removedId!=null&&(isHiding!=null||removedId==="all")){let animeCautions=userList.animeCautions;let cautions=await getContentCaution(animeCautions);if(removedId==="all"){userList.hiddenEntries={};isHiding=false}else if(isHiding){userList.hiddenEntries[removedId]=1}else{delete userList?.hiddenEntries?.[removedId]}let recommendedAnimeListArray=Object.values(recommendedAnimeList);let hiddenEntries=userList.hiddenEntries;let categories=userList?.categories;let categoriesCount=Object.keys(categories||{}).length;let loadedCount=0;let selectedCategory=data?.selectedCategory;if(categories?.[selectedCategory]!=null){let category=categories[selectedCategory];let isHiddenList=category?.isHiddenList;let animeList=category?.animeList;++loadedCount;let loadedPercent=Math.min(1,loadedCount/categoriesCount);let idx;if(isHiding!==isHiddenList){if(removedId==="all"){category.animeList=[]}else{category.animeList=animeList.filter((id,i)=>{if(id===removedId){idx=i;return false}return true})}userList.categories[selectedCategory]=category;self.postMessage({progress:loadedPercent*80})}else{let{animeFilters,sortBy}=category;let newCategory=updateAnimeList(animeFilters,sortBy,recommendedAnimeListArray,hiddenEntries,cautions,loadedPercent);category.animeFilters=newCategory.animeFilters;category.isHiddenList=newCategory.isHiddenList;category.shownSortName=newCategory.shownSortName;category.sortBy=newCategory.sortBy;category.animeList=newCategory.animeList;userList.categories[selectedCategory]=category}self.postMessage({removedIdx:idx,selectedCategory:selectedCategory,postId:postId})}for(let categoryKey in categories){if(categoryKey===selectedCategory)continue;++loadedCount;let loadedPercent=Math.min(1,loadedCount/categoriesCount);let category=categories[categoryKey];let isHiddenList=category?.isHiddenList;let animeList=category?.animeList;if(isHiding!==isHiddenList){if(removedId==="all"){category.animeList=[]}else{category.animeList=animeList.filter(id=>id!==removedId)}userList.categories[categoryKey]=category;loadProgress(loadedPercent*80)}else{let{animeFilters,sortBy}=category;let newCategory=updateAnimeList(animeFilters,sortBy,recommendedAnimeListArray,hiddenEntries,cautions,loadedPercent);category.animeFilters=newCategory.animeFilters;category.isHiddenList=newCategory.isHiddenList;category.shownSortName=newCategory.shownSortName;category.sortBy=newCategory.sortBy;category.animeList=newCategory.animeList;userList.categories[categoryKey]=category}}self.postMessage({progress:85});await saveJSON(userList,"userList").then(()=>{self.postMessage({progress:95});self.postMessage({updateUserList:true,postId:postId})})}else{self.postMessage({progress:95});self.postMessage({postId:postId})}}else if(hasOwnProperty.call(data,"addedCategoryKey")){self.postMessage({status:"Updating Category"});self.postMessage({progress:30});let addedCategoryKey=data?.addedCategoryKey;if(userList!=null&&addedCategoryKey!=null){let copiedCategoryKey=data?.copiedCategoryKey;let categories=userList?.categories;let category=categories?.[copiedCategoryKey];if(category==null){self.postMessage({progress:95});self.postMessage({postId:postId})}else{category=JSON.parse(JSON.stringify(category));userList.categories[addedCategoryKey]=category;self.postMessage({progress:85});await saveJSON(userList,"userList").then(()=>{self.postMessage({progress:95});self.postMessage({updateUserList:true,updateCategories:true,updatedCategoryKey:addedCategoryKey,postId:postId})})}}else{self.postMessage({progress:95});self.postMessage({postId:postId})}}else if(hasOwnProperty.call(data,"renamedCategoryKey")){self.postMessage({status:"Updating Category"});self.postMessage({progress:30});let renamedCategoryKey=data?.renamedCategoryKey;if(userList!=null&&renamedCategoryKey!=null){let replacedCategoryKey=data?.replacedCategoryKey;let categories=userList?.categories;let category=categories?.[replacedCategoryKey];if(category==null){self.postMessage({progress:95});self.postMessage({postId:postId})}else{category=JSON.parse(JSON.stringify(category));userList.categories[renamedCategoryKey]=category;delete userList?.categories?.[replacedCategoryKey];self.postMessage({progress:85});await saveJSON(userList,"userList").then(()=>{self.postMessage({progress:95});self.postMessage({updateUserList:true,updateCategories:true,updatedCategoryKey:renamedCategoryKey,postId:postId})})}}else{self.postMessage({progress:95});self.postMessage({postId:postId})}}else if(hasOwnProperty.call(data,"deletedCategoryKey")){self.postMessage({status:"Updating Category"});self.postMessage({progress:30});let deletedCategoryKey=data?.deletedCategoryKey;if(userList!=null&&deletedCategoryKey!=null){delete userList?.categories?.[deletedCategoryKey];self.postMessage({progress:85});await saveJSON(userList,"userList").then(()=>{self.postMessage({progress:95});self.postMessage({updateUserList:true,updateCategories:true,postId:postId})})}else{self.postMessage({progress:95});self.postMessage({postId:postId})}}else{clearTimeout(updateAllMediaJob);self.postMessage({removedPostWork:true});updateAllMediaJob=setTimeout(async()=>{if(!updateRecommendedAnimeList){if(await retrieveJSON("shouldLoadAnime")){recommendedAnimeList=await retrieveJSON("recommendedAnimeList");updateRecommendedAnimeList=true}}if(recommendedAnimeList!=null&&userList!=null){self.postMessage({status:"Updating Lists"});animeCautions=data?.animeCautions||animeCautions;if(animeCautions instanceof Array){data.updateAnimeCautions=true;self.postMessage({progress:30});await callUpdateUserList(updateRecommendedAnimeList,updateUserList,postId,animeCautions);animeCautions=undefined}else{callUpdateUserList(updateRecommendedAnimeList,updateUserList,postId)}}else{self.postMessage({progress:95});self.postMessage({postId:postId})}},0)}}catch(reason){console.error(reason);let error=reason?.stack||reason?.message;if(typeof error!=="string"||!error){error="Something went wrong"}self.postMessage({error:error,postId:postId})}if(messageQueue.length>0){executeMessage()}else{isProcessing=false}}async function callUpdateUserList(updateRecommendedAnimeList,updateUserList,postId,updateAnimeCautions){let categories=userList?.categories||{};let categoriesCount=Object.keys(categories||{}).length;let loadedCount=0;let recommendedAnimeListArray=Object.values(recommendedAnimeList||{});let hiddenEntries=userList.hiddenEntries;if(updateAnimeCautions instanceof Array){userList.animeCautions=updateAnimeCautions}let animeCautions=userList.animeCautions;let cautions=await getContentCaution(animeCautions);for(let categoryKey in categories){let category=categories?.[categoryKey]||{};++loadedCount;let loadedPercent=Math.min(1,loadedCount/categoriesCount);if(category==null)continue;let{animeFilters,sortBy}=category;let newCategory=updateAnimeList(animeFilters,sortBy,recommendedAnimeListArray,hiddenEntries,cautions,loadedPercent);category.animeFilters=newCategory.animeFilters;category.isHiddenList=newCategory.isHiddenList;category.shownSortName=newCategory.shownSortName;category.sortBy=newCategory.sortBy;category.animeList=newCategory.animeList;userList.categories[categoryKey]=category}self.postMessage({progress:85});await saveJSON(userList,"userList").then(async()=>{await saveJSON(false,"shouldLoadAnime");self.postMessage({progress:95});const updates={postId:postId};if(updateUserList||updateAnimeCautions){updates.updateUserList=true}if(updateRecommendedAnimeList){updates.updateRecommendedAnimeList=true}if(updateAnimeCautions instanceof Array){updates.updateAnimeCautions=true}self.postMessage(updates)})}async function getContentCaution(animeCautions){let semiContentCautions={genres:{},tags:{}},cautionContents={genres:{},tags:{}};for(let i=0,l=animeCautions?.length;i<l;i++){let{status,filterType,optionName,optionCategory}=animeCautions[i]||{};if(status==="included"){if(filterType==="selection"){if(optionCategory==="genre"){semiContentCautions.genres[optionName.toLowerCase()]=true}else if(optionCategory==="tag"){semiContentCautions.tags[optionName.toLowerCase()]=true}}}else if(status==="excluded"){if(filterType==="selection"){if(optionCategory==="genre"){cautionContents.genres[optionName.toLowerCase()]=true}else if(optionCategory==="tag"){cautionContents.tags[optionName.toLowerCase()]=true}}}}return{semiContentCautions:semiContentCautions,cautionContents:cautionContents}}function updateAnimeList(animeFilters,sortBy,recommendedAnimeListArray,hiddenEntries,cautions,loadedPercent=1){let flexibleInclusion={genreTagStudio:false,genreTag:false,genreStudio:false,tagStudio:false,genres:false,tags:false,studios:false},include={genres:{},tags:{},season:{},sequentialSeason:{},format:{},countryOfOrigin:{},status:{},userStatus:{},studios:{},year:{},shownList:{}},exclude={genres:{},tags:{},season:{},sequentialSeason:{},format:{},countryOfOrigin:{},status:{},userStatus:{},studios:{},year:{},shownList:{}},comparisonFilter={weightedScore:null,score:null,averageScore:null,userScore:null,popularity:null,year:null},shownSortName,animeIncluded;let showHiddenList=false,hideMyList=false,hideMyFinishedList=false,showMyList=false,showAllSequels=false,showUserUnwatchedSequel=false,showAnimeAdapted=false,hasUnseenProgress=false;const{semiContentCautions,cautionContents}=cautions;for(let i=0,l=animeFilters?.length;i<l;i++){let{status,filterType,optionName,optionCategory,optionValue,CMPOperator,CMPNumber}=animeFilters[i]||{};if(status==="included"){if(filterType==="selection"){if(optionCategory==="shown score"){shownSortName=optionName.toLowerCase()}else if(optionCategory==="flexible inclusion"){let lowerOptionName=optionName.toLowerCase();if(lowerOptionName==="or: genre / tag / studio"){flexibleInclusion.genreTagStudio=true}else if(lowerOptionName==="or: genre / tag"){flexibleInclusion.genreTag=true}else if(lowerOptionName==="or: genre / studio"){flexibleInclusion.genreStudio=true}else if(lowerOptionName==="or: tag / studio"){flexibleInclusion.tagStudio=true}else if(lowerOptionName==="or: genre"){flexibleInclusion.genres=true}else if(lowerOptionName==="or: tag"){flexibleInclusion.tags=true}else if(lowerOptionName==="or: studio"){flexibleInclusion.studios=true}}else if(optionCategory==="shown list"){include.shownList[optionName.toLowerCase()]=true}else if(optionCategory==="genre"){include.genres[optionName.toLowerCase()]=true}else if(optionCategory==="tag"){include.tags[optionName.toLowerCase()]=true}else if(optionCategory==="year"){include.year[optionName]=true}else if(optionCategory==="season"){let lowerOptionName=optionName.toLowerCase();if(lowerOptionName==="current season"||lowerOptionName==="next season"||lowerOptionName==="previous season"||lowerOptionName==="ongoing seasons"||lowerOptionName==="future seasons"||lowerOptionName==="past seasons"){hasNonBaselineIncludedSeason=true;include.sequentialSeason[lowerOptionName]=true}else{include.season[lowerOptionName]=true}}else if(optionCategory==="format"){let lowerOptionName=optionName.toLowerCase();if(lowerOptionName==="anime"){animeIncluded=true}else{include.format[lowerOptionName]=true}}else if(optionCategory==="country of origin"){include.countryOfOrigin[optionName.toLowerCase()]=true}else if(optionCategory==="airing status"){include.status[optionName.toLowerCase()]=true}else if(optionCategory==="user status"){include.userStatus[optionName.toLowerCase()]=true}else if(optionCategory==="studio"){include.studios[optionName.toLowerCase()]=true}}else if(filterType==="bool"){if(optionName.toLowerCase()==="hide my list"){hideMyList=true}else if(optionName.toLowerCase()==="hide my finished list"){hideMyFinishedList=true}else if(optionName.toLowerCase()==="show my list"){showMyList=true}else if(optionName.toLowerCase()==="show all sequels"){showAllSequels=true}else if(optionName.toLowerCase()==="show next sequel"){showUserUnwatchedSequel=true}else if(optionName.toLowerCase()==="show anime adapted"){showAnimeAdapted=true}else if(optionName.toLowerCase()==="has unseen progress"){hasUnseenProgress=true}else if(optionName.toLowerCase()==="hidden list"){showHiddenList=true}}else if(filterType==="number"){if(optionName.toLowerCase()==="weighted score"){comparisonFilter.weightedScore={operator:CMPOperator?.trim?.(),value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="score"){comparisonFilter.score={operator:CMPOperator?.trim?.(),value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="average score"){comparisonFilter.averageScore={operator:CMPOperator?.trim?.(),value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="user score"){comparisonFilter.userScore={operator:CMPOperator?.trim?.(),value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="popularity"){comparisonFilter.popularity={operator:CMPOperator?.trim?.(),value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="year"){comparisonFilter.year={operator:CMPOperator?.trim?.(),value:parseFloat(CMPNumber??optionValue)}}}}else if(status==="excluded"){if(filterType==="selection"){if(optionCategory==="shown list"){exclude.shownList[optionName.toLowerCase()]=true}else if(optionCategory==="genre"){exclude.genres[optionName.toLowerCase()]=true}else if(optionCategory==="tag"){exclude.tags[optionName.toLowerCase()]=true}else if(optionCategory==="year"){exclude.year[optionName]=true}else if(optionCategory==="season"){let lowerOptionName=optionName.toLowerCase();if(lowerOptionName==="current season"||lowerOptionName==="next season"||lowerOptionName==="previous season"||lowerOptionName==="ongoing seasons"||lowerOptionName==="future seasons"||lowerOptionName==="past seasons"){exclude.sequentialSeason[lowerOptionName]=true}else{exclude.season[lowerOptionName]=true}}else if(optionCategory==="format"){let lowerOptionName=optionName.toLowerCase();if(lowerOptionName==="anime"){animeIncluded=false}else{exclude.format[lowerOptionName]=true}}else if(optionCategory==="country of origin"){exclude.countryOfOrigin[optionName.toLowerCase()]=true}else if(optionCategory==="airing status"){exclude.status[optionName.toLowerCase()]=true}else if(optionCategory==="user status"){exclude.userStatus[optionName.toLowerCase()]=true}else if(optionCategory==="studio"){exclude.studios[optionName.toLowerCase()]=true}}}}let hasFilter={genres:{include:!jsonIsEmpty(include.genres),exclude:!jsonIsEmpty(exclude.genres)},tags:{include:!jsonIsEmpty(include.tags),exclude:!jsonIsEmpty(exclude.tags)},season:{include:!jsonIsEmpty(include.season),exclude:!jsonIsEmpty(exclude.season)},sequentialSeason:{include:!jsonIsEmpty(include.sequentialSeason),exclude:!jsonIsEmpty(exclude.sequentialSeason)},format:{include:!jsonIsEmpty(include.format),exclude:!jsonIsEmpty(exclude.format)},countryOfOrigin:{include:!jsonIsEmpty(include.countryOfOrigin),exclude:!jsonIsEmpty(exclude.countryOfOrigin)},status:{include:!jsonIsEmpty(include.status),exclude:!jsonIsEmpty(exclude.status)},userStatus:{include:!jsonIsEmpty(include.userStatus),exclude:!jsonIsEmpty(exclude.userStatus)},studios:{include:!jsonIsEmpty(include.studios),exclude:!jsonIsEmpty(exclude.studios)},year:{include:!jsonIsEmpty(include.year),exclude:!jsonIsEmpty(exclude.year)},shownList:{include:!jsonIsEmpty(include.shownList),exclude:!jsonIsEmpty(exclude.shownList)},flexibleInclusion:{combinedGenres:flexibleInclusion.genreTagStudio||flexibleInclusion.genreStudio||flexibleInclusion.genreTag,combinedTags:flexibleInclusion.genreTagStudio||flexibleInclusion.genreTag||flexibleInclusion.tagStudio,combinedStudios:flexibleInclusion.genreTagStudio||flexibleInclusion.genreStudio||flexibleInclusion.tagStudio},cautionContents:{genres:!jsonIsEmpty(cautionContents.genres),tags:!jsonIsEmpty(cautionContents.tags)},semiContentCautions:{genres:!jsonIsEmpty(semiContentCautions.genres),tags:!jsonIsEmpty(semiContentCautions.tags)}};let recommendedAnimeListArrayLen=recommendedAnimeListArray.length;let animeList=recommendedAnimeListArray.filter((anime,idx)=>{loadProgress(Math.min((idx+1)/recommendedAnimeListArrayLen*loadedPercent*100,80));if(hideMyList){if(anime?.userStatus?.toLowerCase?.()!=="unwatched"){return false}}if(showMyList){if(typeof anime?.userStatus!=="string"||anime.userStatus.toLowerCase()==="unwatched"){return false}}if(showHiddenList){if(hiddenEntries?.[anime?.id]===undefined){return false}}else{if(hiddenEntries[anime?.id]){return false}}if(hideMyFinishedList){let loweredUserStatus=anime?.userStatus?.toLowerCase?.();if(loweredUserStatus==="completed"||loweredUserStatus==="dropped"){return false}}let entryMightBeAnime;if(hasUnseenProgress){let loweredUserStatus=anime?.userStatus?.toLowerCase?.(),loweredStatus=anime?.status?.toLowerCase?.();if(loweredUserStatus==="completed"||loweredStatus==="not yet released"){return false}else{let currentProgress,releasedProgress,entryIsFinished=loweredStatus==="finished",lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel";if(entryMightBeAnime){currentProgress=anime?.episodeProgress;if(entryIsFinished){releasedProgress=anime?.episodes}if(!(releasedProgress>0)){const nextAiringEpisode=anime?.nextAiringEpisode;const nextEpisodeIsAired=nextAiringEpisode?.airingAt*1e3<=(new Date).getTime();const airingEpisode=nextAiringEpisode?.episode??1;releasedProgress=nextEpisodeIsAired?airingEpisode:airingEpisode-1}}else{if(entryIsFinished){currentProgress=anime?.episodeProgress;releasedProgress=anime?.chapters;if(!(releasedProgress>0&&currentProgress>0)){currentProgress=anime?.volumeProgress;releasedProgress=anime?.volumes}}}if(typeof releasedProgress!=="number"||isNaN(releasedProgress)||!isFinite(releasedProgress)||(currentProgress||0)>=releasedProgress){return false}}}if(comparisonFilter.userScore){let operator=comparisonFilter.userScore.operator,value=comparisonFilter.userScore.value;if(typeof anime?.userScore!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(anime?.userScore<value)return false;break}case"<=":{if(anime?.userScore>value)return false;break}case"<":{if(anime?.userScore>=value)return false;break}case">":{if(anime?.userScore<=value)return false;break}}}else if(anime?.userScore!==value){return false}}}if(comparisonFilter.averageScore){let operator=comparisonFilter.averageScore.operator,value=comparisonFilter.averageScore.value;if(typeof anime?.averageScore!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(anime?.averageScore<value)return false;break}case"<=":{if(anime?.averageScore>value)return false;break}case"<":{if(anime?.averageScore>=value)return false;break}case">":{if(anime?.averageScore<=value)return false;break}}}else if(anime?.averageScore!==value){return false}}}if(comparisonFilter.popularity){let operator=comparisonFilter.popularity.operator,value=comparisonFilter.popularity.value;if(typeof anime?.popularity!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(anime?.popularity<value)return false;break}case"<=":{if(anime?.popularity>value)return false;break}case"<":{if(anime?.popularity>=value)return false;break}case">":{if(anime?.popularity<=value)return false;break}}}else if(anime?.popularity!==value){return false}}}if(comparisonFilter.weightedScore){let operator=comparisonFilter.weightedScore.operator,value=comparisonFilter.weightedScore.value;if(typeof anime?.weightedScore!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(anime?.weightedScore<value)return false;break}case"<=":{if(anime?.weightedScore>value)return false;break}case"<":{if(anime?.weightedScore>=value)return false;break}case">":{if(anime?.weightedScore<=value)return false;break}}}else if(anime?.weightedScore!==value){return false}}}if(comparisonFilter.score){let operator=comparisonFilter.score.operator,value=comparisonFilter.score.value;if(typeof anime?.score!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(anime?.score<value)return false;break}case"<=":{if(anime?.score>value)return false;break}case"<":{if(anime?.score>=value)return false;break}case">":{if(anime?.score<=value)return false;break}}}else if(anime?.score!==value){return false}}}if(comparisonFilter.year){if(anime?.year==null)return false;let year=parseInt(anime?.year);if(isNaN(year))return false;let operator=comparisonFilter.year.operator,value=comparisonFilter.year.value;if(typeof year!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(year<value)return false;break}case"<=":{if(year>value)return false;break}case"<":{if(year>=value)return false;break}case">":{if(year<=value)return false;break}}}else if(year!==value){return false}}}if(animeIncluded===false){if(typeof anime?.format==="string"){let lowerFormat=anime.format.toLowerCase();let entryIsAnime=lowerFormat==="tv"||lowerFormat==="movie"||lowerFormat==="ona"||lowerFormat==="special"||lowerFormat==="tv short"||lowerFormat==="ova";if(entryIsAnime){return false}}}if(typeof anime?.format==="string"&&exclude.format[anime.format.toLowerCase()]){return false}if(typeof anime?.countryOfOrigin==="string"&&exclude.countryOfOrigin[anime.countryOfOrigin.toLowerCase()]){return false}if(typeof anime?.userStatus==="string"&&exclude.userStatus[anime.userStatus.toLowerCase()]){return false}if(typeof anime?.status==="string"&&exclude.status[anime.status.toLowerCase()]){return false}if(anime?.year!=null&&exclude.year[anime?.year?.toString()]){return false}if(typeof anime?.season==="string"&&exclude.season[anime.season.toLowerCase()]){return false}if(hasFilter.sequentialSeason.exclude){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}let season=anime?.season?.toLowerCase?.();let hasSeason=season==="winter"||season==="spring"||season==="summer"||season==="fall";if(entryMightBeAnime||hasSeason){if(exclude.sequentialSeason["current season"]||exclude.sequentialSeason["next season"]||exclude.sequentialSeason["previous season"]||exclude.sequentialSeason["ongoing seasons"]||exclude.sequentialSeason["future seasons"]||exclude.sequentialSeason["past seasons"]){let year=parseInt(anime?.year);if(!isNaN(year)){let currentSeasonYear=getCurrentSeasonYear()||{};if(hasSeason){const seasonYear=`${season} ${year}`;if((exclude.sequentialSeason["current season"]||exclude.sequentialSeason["ongoing seasons"])&&seasonYear===currentSeasonYear.seasonYear){return false}if((exclude.sequentialSeason["next season"]||exclude.sequentialSeason["future seasons"])&&seasonYear===currentSeasonYear.nextSeasonYear){return false}if((exclude.sequentialSeason["previous season"]||exclude.sequentialSeason["past seasons"])&&seasonYear===currentSeasonYear.previousSeasonYear){return false}}if((exclude.sequentialSeason["ongoing seasons"]||exclude.sequentialSeason["past seasons"])&&(year<currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.pastSeasonsInCurrentYear?.[season])){if(exclude.sequentialSeason["past seasons"]){return false}else if(typeof anime?.status==="string"){let loweredStatus=anime?.status?.toLowerCase?.();if(loweredStatus==="releasing"||loweredStatus==="not yet released"){return false}}}if(exclude.sequentialSeason["future seasons"]&&(year>currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.futureSeasonsInCurrentYear?.[season])){return false}}}}}let studioArray;if(hasFilter.shownList.exclude){if(exclude.shownList["recommended studios"]){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}if(entryMightBeAnime&&isJsonObject(anime?.favoriteContents?.studios)&&!jsonIsEmpty(anime.favoriteContents.studios)){studioArray=Object.keys(anime.studios||{});if(studioArray.some(studio=>typeof studio==="string"&&anime.favoriteContents.studios[studio.toLowerCase()])){return false}}}if(exclude.shownList["non-caution"]){if(hasFilter.cautionContents.genres&&!anime?.genres?.some(genre=>typeof genre==="string"&&cautionContents.genres[genre.toLowerCase()])||hasFilter.cautionContents.tags&&!anime?.tags?.some(tag=>typeof tag?.name==="string"&&cautionContents.tags[tag.name.toLowerCase()])){return false}}if(exclude.shownList["non-semi-caution"]){if(hasFilter.semiContentCautions.genres&&!anime?.genres?.some(genre=>typeof genre==="string"&&semiContentCautions.genres[genre.toLowerCase()])||hasFilter.semiContentCautions.tags&&!anime?.tags?.some(tag=>typeof tag?.name==="string"&&semiContentCautions.tags[tag.name.toLowerCase()])){return false}}if(exclude.shownList["recommended score"]||exclude.shownList["semi-recommended score"]||exclude.shownList["other"]){if(typeof anime?.score!=="number"){return false}if(exclude.shownList["recommended score"]){if(typeof anime?.meanScoreAbove!=="number")return false;if(anime.score>=anime.meanScoreAbove)return false}if(exclude.shownList["semi-recommended score"]){if(typeof anime?.meanScoreAll!=="number"||typeof anime?.meanScoreAbove!=="number")return false;if(anime.score<anime.meanScoreAbove&&anime.score>=anime.meanScoreAll)return false}if(exclude.shownList["other"]){if(typeof anime.meanScoreAll!=="number")return false;if(anime.score<anime.meanScoreAll)return false}}}if(hasFilter.genres.exclude){if(anime?.genres?.some(genre=>typeof genre==="string"&&exclude.genres[genre.toLowerCase()]))return false}if(hasFilter.tags.exclude){if(anime?.tags?.some(tag=>typeof tag?.name==="string"&&exclude.tags[tag.name.toLowerCase()]))return false}if(hasFilter.studios.exclude){studioArray=studioArray||Object.keys(anime.studios||{});if(studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&exclude.studios[studio.toLowerCase()])){return false}}}if(hasFilter.shownList.include){if(include.shownList["recommended studios"]){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}studioArray=studioArray||Object.keys(anime.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(isJsonObject(anime?.favoriteContents?.studios)){if(jsonIsEmpty(anime.favoriteContents.studios))return false;if(!studioArray.some(studio=>typeof studio==="string"&&anime.favoriteContents.studios[studio.toLowerCase()])){return false}}}}if(include.shownList["non-caution"]){if(anime?.genres?.some(genre=>typeof genre==="string"&&cautionContents.genres[genre.toLowerCase()]))return false;if(anime?.tags?.some(tag=>typeof tag?.name==="string"&&cautionContents.tags[tag.name.toLowerCase()]))return false}if(include.shownList["non-semi-caution"]){if(anime?.genres?.some(genre=>typeof genre==="string"&&semiContentCautions.genres[genre.toLowerCase()]))return false;if(anime?.tags?.some(tag=>typeof tag?.name==="string"&&semiContentCautions.tags[tag.name.toLowerCase()]))return false}if(include.shownList["recommended score"]||include.shownList["semi-recommended score"]||include.shownList["other"]){if(typeof anime?.score!=="number"){return false}if(include.shownList["recommended score"]&&include.shownList["semi-recommended score"]){if(typeof anime?.meanScoreAll!=="number")return false;if(anime.score<anime.meanScoreAll)return false}else if(include.shownList["recommended score"]&&include.shownList["other"]){if(typeof anime?.meanScoreAll!=="number"||typeof anime?.meanScoreAbove!=="number")return false;if(anime.score<anime.meanScoreAbove&&anime.score>=anime.meanScoreAll)return false}else if(include.shownList["semi-recommended score"]&&include.shownList["other"]){if(typeof anime?.meanScoreAbove!=="number")return false;if(anime.score>=anime.meanScoreAbove)return false}else if(include.shownList["recommended score"]){if(typeof anime?.meanScoreAbove!=="number")return false;if(anime.score<anime.meanScoreAbove)return false}else if(include.shownList["semi-recommended score"]){if(typeof anime?.meanScoreAll!=="number"||typeof anime?.meanScoreAbove!=="number")return false;if(anime.score>=anime.meanScoreAbove||anime.score<anime.meanScoreAll)return false}else if(include.shownList["other"]){if(typeof anime?.meanScoreAll!=="number")return false;if(anime.score>=anime.meanScoreAll)return false}}}if(hasFilter.sequentialSeason.include){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}let season=anime?.season?.toLowerCase?.();let hasSeason=season==="winter"||season==="spring"||season==="summer"||season==="fall";if(entryMightBeAnime||hasSeason){if(include.sequentialSeason["current season"]||include.sequentialSeason["next season"]||include.sequentialSeason["previous season"]||include.sequentialSeason["ongoing seasons"]||include.sequentialSeason["future seasons"]||include.sequentialSeason["past seasons"]){let isNotIncluded;do{let year=parseInt(anime?.year);if(!isNaN(year)){let currentSeasonYear=getCurrentSeasonYear()||{};if(hasSeason){const seasonYear=`${season} ${year}`;if((include.sequentialSeason["current season"]||include.sequentialSeason["ongoing seasons"])&&seasonYear===currentSeasonYear.seasonYear){break}if((include.sequentialSeason["next season"]||include.sequentialSeason["future seasons"])&&seasonYear===currentSeasonYear.nextSeasonYear){break}if((include.sequentialSeason["previous season"]||include.sequentialSeason["past seasons"])&&seasonYear===currentSeasonYear.previousSeasonYear){break}}if((include.sequentialSeason["ongoing seasons"]||include.sequentialSeason["past seasons"])&&(year<currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.pastSeasonsInCurrentYear?.[season])){if(include.sequentialSeason["past seasons"]){break}else if(typeof anime?.status==="string"){let loweredStatus=anime?.status?.toLowerCase?.();if(loweredStatus==="releasing"||loweredStatus==="not yet released"){break}}}if(include.sequentialSeason["future seasons"]&&(year>currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.futureSeasonsInCurrentYear?.[season])){break}}isNotIncluded=true;break}while(false);if(isNotIncluded){return false}}}}if(hasFilter.season.include){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}let season=anime?.season?.toLowerCase?.();let hasSeason=season==="winter"||season==="spring"||season==="summer"||season==="fall";if(entryMightBeAnime||hasSeason){if(!include.season[season]){return false}}}if(animeIncluded===true){if(typeof anime?.format==="string"){let lowerFormat=anime.format.toLowerCase();if(lowerFormat==="manga"&&!include.format.manga||lowerFormat==="one shot"&&!include.format["one shot"]||lowerFormat==="novel"&&!include.format.novel){return false}}}else if(hasFilter.format.include){if(typeof anime?.format!=="string"||!include.format[anime.format.toLowerCase()]){return false}}if(hasFilter.countryOfOrigin.include){if(typeof anime?.countryOfOrigin!=="string"||!include.countryOfOrigin[anime.countryOfOrigin.toLowerCase()]){return false}}if(hasFilter.userStatus.include){if(typeof anime?.userStatus!=="string"||!include.userStatus[anime.userStatus.toLowerCase()]){return false}}if(hasFilter.status.include){if(typeof anime?.status!=="string"||!include.status[anime.status.toLowerCase()]){return false}}if(hasFilter.year.include){if(anime?.year==null||!include.year[anime?.year?.toString?.()]){return false}}if(flexibleInclusion.genreTagStudio){let isNotIncluded;do{if(!hasFilter.genres.include&&!hasFilter.tags.include&&!hasFilter.studios.include){break}if(hasFilter.genres.include&&anime?.genres?.some?.(genre=>typeof genre==="string"&&include.genres[genre.toLowerCase()])){break}if(hasFilter.tags.include&&anime?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name.toLowerCase()])){break}if(hasFilter.studios.include){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}studioArray=studioArray||Object.keys(anime?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&include.studios[studio.toLowerCase()])){break}}else{break}}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}else if(flexibleInclusion.genreTag){let isNotIncluded;do{if(!hasFilter.genres.include&&!hasFilter.tags.include){break}if(hasFilter.genres.include&&anime?.genres?.some?.(genre=>typeof genre==="string"&&include.genres[genre.toLowerCase()])){break}if(hasFilter.tags.include&&anime?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name.toLowerCase()])){break}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}else if(flexibleInclusion.genreStudio){let isNotIncluded;do{if(!hasFilter.genres.include&&!hasFilter.studios.include){break}if(hasFilter.genres.include&&anime?.genres?.some?.(genre=>typeof genre==="string"&&include.genres[genre.toLowerCase()])){break}if(hasFilter.studios.include){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}studioArray=studioArray||Object.keys(anime?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&include.studios[studio.toLowerCase()])){break}}else{break}}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}else if(flexibleInclusion.tagStudio){let isNotIncluded;do{if(!hasFilter.tags.include&&!hasFilter.studios.include){break}if(hasFilter.tags.include&&anime?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name.toLowerCase()])){break}if(hasFilter.studios.include){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}studioArray=studioArray||Object.keys(anime?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&include.studios[studio.toLowerCase()])){break}}else{break}}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}if(!hasFilter.flexibleInclusion.combinedGenres&&hasFilter.genres.include){if(flexibleInclusion.genres){if(!anime?.genres?.some(genre=>typeof genre==="string"&&include.genres[genre.toLowerCase()])){return false}}else{for(let genre in include.genres){let loweredGenre=genre.toLowerCase();if(!anime?.genres?.some(genre=>typeof genre==="string"&&genre.toLowerCase()===loweredGenre)){return false}}}}if(!hasFilter.flexibleInclusion.combinedTags&&hasFilter.tags.include){if(flexibleInclusion.tags){if(!anime?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name.toLowerCase()])){return false}}else{for(let tag in include.tags){let loweredTagName=tag.toLowerCase();if(!anime?.tags?.some(tag=>typeof tag?.name==="string"&&tag.name.toLowerCase()===loweredTagName)){return false}}}}if(!hasFilter.flexibleInclusion.combinedStudios&&hasFilter.studios.include){if(entryMightBeAnime==null){let lowerFormat=anime?.format?.toLowerCase?.();entryMightBeAnime=lowerFormat!=="manga"&&lowerFormat!=="one shot"&&lowerFormat!=="novel"}studioArray=studioArray||Object.keys(anime?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(flexibleInclusion.studios){if(!studioArray.some(studio=>typeof studio==="string"&&include.studios[studio.toLowerCase()]))return false}else{for(let studio in include.studios){let loweredStudio=studio.toLowerCase();if(!studioArray.some(studio=>typeof studio==="string"&&studio.toLowerCase()===loweredStudio)){return false}}}}}let animeRelations=anime?.animeRelations;if(animeRelations instanceof Array){if(showUserUnwatchedSequel){let userStatus=anime?.userStatus?.toLowerCase?.();let isNotUserAnimeUnwatchedSequel=userStatus==="completed"||userStatus==="repeating"||userStatus==="dropped"||!animeRelations.some(e=>{if(e?.relationType?.toLowerCase?.()==="prequel"){let animeRelationID=e?.node?.id;if(animeRelationID!=null){animeRelationID=Math.floor(animeRelationID);let relationAnime=recommendedAnimeListArray?.find?.(anime=>anime?.id!=null&&Math.floor(anime?.id)===animeRelationID);let relationStatus=relationAnime?.userStatus?.toLowerCase?.();return relationStatus==="completed"||relationStatus==="repeating"}}});if(isNotUserAnimeUnwatchedSequel){return false}}if(!showAllSequels){let isUnwatchedSequel=!animeRelations.some(e=>e?.relationType?.toLowerCase?.()==="prequel")||animeRelations.some(e=>{if(e?.relationType?.toLowerCase?.()==="prequel"){let animeRelationID=e?.node?.id;if(animeRelationID!=null){animeRelationID=Math.floor(animeRelationID);let relationAnime=recommendedAnimeListArray?.find?.(anime=>anime?.id!=null&&Math.floor(anime?.id)===animeRelationID);let relationStatus=relationAnime?.userStatus?.toLowerCase?.();if(relationStatus!=="unwatched"&&relationStatus!=="dropped"){return true}else{return e?.node?.popularity<anime?.popularity}}}});if(!isUnwatchedSequel){return false}}if(!showAnimeAdapted){let lowerFormat=anime?.format?.toLowerCase?.();if(lowerFormat==="manga"||lowerFormat==="one shot"||lowerFormat==="novel"){let hasAnimeAdaptation=animeRelations.some(e=>{let animeRelationType=e?.relationType?.toLowerCase?.();if(animeRelationType==="adaptation"||animeRelationType==="alternative"){let animeRelationID=e?.node?.id;if(animeRelationID!=null){animeRelationID=Math.floor(animeRelationID);let relationAnime=recommendedAnimeListArray?.find?.(anime=>anime?.id!=null&&Math.floor(anime?.id)===animeRelationID);let relationFormat=relationAnime?.format?.toLowerCase?.();let possibleAnime=relationFormat!=="manga"&&relationFormat!=="one shot"&&relationFormat!=="novel";if(possibleAnime){let relationStatus=relationAnime?.status?.toLowerCase?.();return relationStatus==="finished"||relationStatus==="releasing"||relationStatus==="not yet released"}}}});if(hasAnimeAdaptation){return false}}}}return true});let sortType=sortBy?.sortType||"desc";let sortName=sortBy?.sortName||"weighted score";if(sortType==="desc"){if(sortName==="weighted score"){animeList.sort((a,b)=>{let x=a?.weightedScore!=null?a.weightedScore:-Infinity,y=b?.weightedScore!=null?b.weightedScore:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;return y-x})}else if(sortName==="score"){animeList.sort((a,b)=>{let x=a?.score!=null?a.score:-Infinity,y=b?.score!=null?b.score:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;return y-x})}else if(sortName==="average score"){animeList.sort((a,b)=>{let x=a?.averageScore!=null?a.averageScore:-Infinity,y=b?.averageScore!=null?b.averageScore:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="user score"){animeList.sort((a,b)=>{let x=a?.userScore!=null?a.userScore:-Infinity,y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;if(x!==y)return y-x;x=a?.averageScore!=null?a.averageScore:-Infinity;y=b?.averageScore!=null?b.averageScore:-Infinity;return y-x})}else if(sortName==="popularity"){animeList.sort((a,b)=>{let x=a?.popularity!=null?a.popularity:-Infinity,y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.favorites!=null?a.favorites:-Infinity;y=b?.favorites!=null?b.favorites:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="trending"){animeList.sort((a,b)=>{let x=a?.trending!=null?a.trending:-Infinity,y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.favorites!=null?a.favorites:-Infinity;y=b?.favorites!=null?b.favorites:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="favorites"){animeList.sort((a,b)=>{let x=a?.favorites!=null?a.favorites:-Infinity,y=b?.favorites!=null?b.favorites:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.averageScore!=null?a.averageScore:-Infinity;y=b?.averageScore!=null?b.averageScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="date updated"){animeList.sort((a,b)=>{let x=a?.dateEdited||a?.dateAdded?Math.max(a?.dateEdited||0,a?.dateAdded||0):-Infinity,y=b?.dateEdited||b?.dateAdded?Math.max(b?.dateEdited||0,b?.dateAdded||0):-Infinity;if(x!==y)return y-x;let year=a?.year;let season=a?.season?.toLowerCase?.();let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season?.toLowerCase?.();startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=dateA!=null?dateA:-Infinity;y=dateB!=null?dateB:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="date added"){animeList.sort((a,b)=>{let x=a?.id!=null?parseInt(a?.id):-Infinity,y=b?.id!=null?parseInt(b?.id):-Infinity;if(x!==y)return y-x;x=a?.dateAdded?a?.dateAdded:-Infinity;y=b?.dateAdded?b?.dateAdded:-Infinity;if(x!==y)return y-x;let year=a?.year;let season=a?.season?.toLowerCase?.();let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season?.toLowerCase?.();startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=dateA!=null?dateA:-Infinity;y=dateB!=null?dateB:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="date"){animeList.sort((a,b)=>{let year=a?.year;let season=a?.season?.toLowerCase?.();let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season?.toLowerCase?.();startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();let x=dateA!=null?dateA:-Infinity;let y=dateB!=null?dateB:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}}else if(sortType==="asc"){if(sortName==="weighted score"){animeList.sort((a,b)=>{let x=a?.weightedScore!=null?a?.weightedScore:Infinity,y=b?.weightedScore!=null?b?.weightedScore:Infinity;return x-y})}else if(sortName==="score"){animeList.sort((a,b)=>{let x=a?.score!=null?a?.score:Infinity,y=b?.score!=null?b?.score:Infinity;return x-y})}else if(sortName==="average score"){animeList.sort((a,b)=>{let x=a?.averageScore!=null?a?.averageScore:Infinity,y=b?.averageScore!=null?b?.averageScore:Infinity;return x-y})}else if(sortName==="user score"){animeList.sort((a,b)=>{let x=a?.userScore!=null?a?.userScore:Infinity,y=b?.userScore!=null?b?.userScore:Infinity;return x-y})}else if(sortName==="popularity"){animeList.sort((a,b)=>{let x=a?.popularity!=null?a?.popularity:Infinity,y=b?.popularity!=null?b?.popularity:Infinity;return x-y})}else if(sortName==="trending"){animeList.sort((a,b)=>{let x=a?.trending!=null?a?.trending:Infinity,y=b?.trending!=null?b?.trending:Infinity;if(x!==y)return x-y;x=a?.popularity!=null?a.popularity:Infinity;y=b?.popularity!=null?b.popularity:Infinity;return x-y})}else if(sortName==="favorites"){animeList.sort((a,b)=>{let x=a?.favorites!=null?a?.favorites:Infinity,y=b?.favorites!=null?b?.favorites:Infinity;if(x!==y)return x-y;x=a?.popularity!=null?a.popularity:Infinity;y=b?.popularity!=null?b.popularity:Infinity;return x-y})}else if(sortName==="date updated"){animeList.sort((a,b)=>{let x=a?.dateEdited||a?.dateAdded?Math.max(a?.dateEdited||0,a?.dateAdded||0):Infinity,y=b?.dateEdited||b?.dateAdded?Math.max(b?.dateEdited||0,b?.dateAdded||0):Infinity;if(x!==y)return x-y;let year=a?.year;let season=a?.season?.toLowerCase?.();let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;x=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season?.toLowerCase?.();startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;y=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=x!=null?x:Infinity;y=y!=null?y:Infinity;return x-y})}else if(sortName==="date added"){animeList.sort((a,b)=>{let x=a?.id!=null?parseInt(a?.id):Infinity,y=b?.id!=null?parseInt(b?.id):Infinity;if(x!==y)return x-y;x=a?.dateAdded?a?.dateAdded:Infinity;y=b?.dateAdded?b?.dateAdded:Infinity;if(x!==y)return x-y;let year=a?.year;let season=a?.season?.toLowerCase?.();let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;x=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season?.toLowerCase?.();startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;y=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=x!=null?x:Infinity;y=y!=null?y:Infinity;return x-y})}else if(sortName==="date"){animeList.sort((a,b)=>{let year=a?.year;let season=a?.season?.toLowerCase?.();let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season?.toLowerCase?.();startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();let x=dateA!=null?dateA:Infinity;let y=dateB!=null?dateB:Infinity;return x-y})}}return{animeList:animeList.map(({id})=>id),isHiddenList:showHiddenList,shownSortName:shownSortName||sortName,animeFilters:animeFilters,sortBy:sortBy}}function getCurrentSeasonYear(){let currentDate=new Date;let year=currentDate.getFullYear();let seasons={winter:new Date(parseInt(year),0,1),spring:new Date(parseInt(year),3,1),summer:new Date(parseInt(year),6,1),fall:new Date(parseInt(year),9,1)};if(isNaN(year))return null;if(currentDate<seasons.spring){return{year:year,seasonYear:`winter ${year}`,nextSeasonYear:`spring ${year}`,previousSeasonYear:`fall ${year-1}`,futureSeasonsInCurrentYear:{spring:true,summer:true,fall:true},pastSeasonsInCurrentYear:{}}}else if(currentDate>=seasons.spring&&currentDate<seasons.summer){return{year:year,seasonYear:`spring ${year}`,nextSeasonYear:`summer ${year}`,previousSeasonYear:`winter ${year}`,futureSeasonsInCurrentYear:{summer:true,fall:true},pastSeasonsInCurrentYear:{winter:true}}}else if(currentDate>=seasons.summer&&currentDate<seasons.fall){return{year:year,seasonYear:`summer ${year}`,nextSeasonYear:`fall ${year}`,previousSeasonYear:`spring ${year}`,futureSeasonsInCurrentYear:{fall:true},pastSeasonsInCurrentYear:{winter:true,spring:true}}}else{return{year:year,seasonYear:`fall ${year}`,nextSeasonYear:`winter ${year+1}`,previousSeasonYear:`summer ${year}`,futureSeasonsInCurrentYear:{},pastSeasonsInCurrentYear:{winter:true,spring:true,summer:true}}}}function getJapaneseStartDate({season,year,month,day}){if(parseInt(year)>=0){if(parseInt(month)>=0){return new Date(parseInt(year),parseInt(month),parseInt(day||1)||1)}const seasonKey=season?.trim()?.toLowerCase?.();if((seasonKey==="winter"||seasonKey==="spring"||seasonKey==="summer"||seasonKey==="fall")&&!isNaN(year)){let seasons={winter:new Date(parseInt(year),0,1),spring:new Date(parseInt(year),3,1),summer:new Date(parseInt(year),6,1),fall:new Date(parseInt(year),9,1)};return seasons[seasonKey]}return new Date(parseInt(year),0,1)}else{return null}}function msToTime(duration,limit){try{if(duration<1e3){return"0s"}let seconds=Math.floor(duration/1e3%60),minutes=Math.floor(duration/6e4%60),hours=Math.floor(duration/36e5%24),days=Math.floor(duration/864e5%7),weeks=Math.floor(duration/6048e5%4),months=Math.floor(duration/24192e5%12),years=Math.floor(duration/290304e5%10),decades=Math.floor(duration/290304e6%10),century=Math.floor(duration/290304e7%10),millenium=Math.floor(duration/290304e8%10);let time=[];if(millenium>0)time.push(`${millenium}mil`);if(century>0)time.push(`${century}cen`);if(decades>0)time.push(`${decades}dec`);if(years>0)time.push(`${years}y`);if(months>0)time.push(`${months}mon`);if(weeks>0)time.push(`${weeks}w`);if(days>0)time.push(`${days}d`);if(hours>0)time.push(`${hours}h`);if(minutes>0)time.push(`${minutes}m`);if(seconds>0)time.push(`${seconds}s`);if(limit>0){time=time.slice(0,limit)}return time.join(" ")||"0s"}catch(e){return""}}function IDBinit(){return new Promise(resolve=>{let request=indexedDB.open("Kanshi.Anime.Recommendations.Anilist.W~uPtWCq=vG$TR:Zl^#t<vdS]I~N70",2);request.onsuccess=event=>{db=event.target.result;resolve()};request.onupgradeneeded=event=>{db=event.target.result;db.createObjectStore("others");event.target.transaction.oncomplete=()=>{resolve()}};request.onerror=error=>{console.error(error)}})}function saveJSON(data,name){return new Promise((resolve,reject)=>{let blob;try{let transaction=db.transaction("others","readwrite");let store=transaction.objectStore("others");let put;if(data instanceof Blob){blob=data;put=store.put(blob,name)}else if(isJsonObject(data)||data instanceof Array){blob=new Blob([JSON.stringify(data)]);put=store.put(blob,name)}else{put=store.put(data,name)}put.onsuccess=()=>{resolve()};put.onerror=ex=>{if(blob instanceof Blob){(async()=>{try{await saveJSON((new FileReaderSync).readAsArrayBuffer(blob),name);resolve()}catch(ex2){console.error(ex);console.error(ex2);reject(ex)}})()}else{console.error(ex);reject(ex)}};try{transaction?.commit?.()}catch{}}catch(ex){if(blob instanceof Blob){(async()=>{try{await saveJSON((new FileReaderSync).readAsArrayBuffer(blob),name);resolve()}catch(ex2){console.error(ex);console.error(ex2);reject(ex)}})()}else{console.error(ex);reject(ex)}}})}function retrieveJSON(name){return new Promise(resolve=>{try{let get=db.transaction("others","readonly").objectStore("others").get(name);get.onsuccess=()=>{let result=get.result;if(result instanceof Blob){result=JSON.parse((new FileReaderSync).readAsText(result))}else if(result instanceof ArrayBuffer){result=JSON.parse((new TextDecoder).decode(result))}resolve(result)};get.onerror=ex=>{console.error(ex);resolve()}}catch(ex){console.error(ex);resolve()}})}function jsonIsEmpty(obj){for(const key in obj){return false}return true}function isJsonObject(obj){return Object.prototype.toString.call(obj)==="[object Object]"}function getDefaultUserList(){let defaultCategories=["   Completed Anime","   Completed Manga","   Completed Novel","  Airing & Upcoming","  Ongoing Manga","  Ongoing Novel"," Next Sequel in My List","Anticipated","My List","Recently Updated"];return{hiddenEntries:{},selectedCategory:"   Completed Anime",animeCautions:[{optionName:"netorare",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"rape",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"prostitution",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"ero guro",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"suicide",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"slavery",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"tragedy",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"ecchi",optionCategory:"genre",status:"included",filterType:"selection"},{optionName:"nudity",optionCategory:"tag",status:"included",filterType:"selection"}],categories:defaultCategories.reduce((acc,addedCategory)=>{let isUserRelated=addedCategory===" Next Sequel in My List"||addedCategory==="My List";let sortName,shownSortName;if(isUserRelated){sortName="score"}else if(addedCategory==="Anticipated"){sortName="popularity"}else if(addedCategory==="Recently Updated"){sortName="date updated"}else{sortName="weighted score"}switch(addedCategory){case"   Completed Anime":{animeFilters=[{optionName:"finished",optionCategory:"airing status",status:"included",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"},{optionName:"anime",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case"   Completed Manga":{animeFilters=[{optionName:"finished",optionCategory:"airing status",status:"included",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"},{optionName:"anime",optionCategory:"format",status:"excluded",filterType:"selection"},{optionName:"novel",optionCategory:"format",status:"excluded",filterType:"selection"}];shownSortName="average score";break}case"   Completed Novel":{animeFilters=[{optionName:"finished",optionCategory:"airing status",status:"included",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"},{optionName:"novel",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case"  Airing & Upcoming":{animeFilters=[{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"releasing",optionCategory:"airing status",status:"included",filterType:"selection"},{optionName:"not yet released",optionCategory:"airing status",status:"included",filterType:"selection"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"},{optionName:"anime",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case"  Ongoing Manga":{animeFilters=[{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"releasing",optionCategory:"airing status",status:"included",filterType:"selection"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"},{optionName:"anime",optionCategory:"format",status:"excluded",filterType:"selection"},{optionName:"novel",optionCategory:"format",status:"excluded",filterType:"selection"}];shownSortName="average score";break}case"  Ongoing Novel":{animeFilters=[{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"releasing",optionCategory:"airing status",status:"included",filterType:"selection"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"},{optionName:"novel",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case" Next Sequel in My List":{animeFilters=[{optionName:"finished",optionCategory:"airing status",status:"none",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"show next sequel",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"}];shownSortName="average score";break}case"Anticipated":{animeFilters=[{optionName:"hide my list",status:"included",filterType:"bool"},{optionName:"hide my finished list",status:"included",filterType:"bool"},{optionName:"not yet released",optionCategory:"airing status",status:"included",filterType:"selection"}];break}case"My List":{animeFilters=[{optionName:"finished",optionCategory:"airing status",status:"none",filterType:"selection"},{optionName:"repeating",optionCategory:"user status",status:"none",filterType:"selection"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"show my list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown score",status:"included",filterType:"selection"}];shownSortName="average score";break}case"Recently Updated":{animeFilters=[{optionName:"show all sequels",filterType:"bool",status:"included"},{optionName:"score",optionCategory:"shown score",status:"included",filterType:"selection"}];shownSortName="score";break}}acc[addedCategory]={isHiddenList:false,shownSortName:shownSortName||sortName,sortBy:{sortName:sortName,sortType:"desc"},animeFilters:animeFilters};return acc},{})}}let startPost=performance.now();function loadProgress(progress){let endPost=performance.now();if(endPost-startPost>17){self.postMessage({progress:progress});startPost=endPost}}