let db,recommendedMediaList,recommendedMediaListArray,hiddenEntries,cautions;self.addEventListener("unhandledrejection",event=>{const reason=event?.reason;console.error(reason);let error=reason?.stack||reason?.message;if(typeof error!=="string"||!error){error="Something went wrong"}self.postMessage({error:error})});self.onmessage=async({data})=>{const postId=data.postId;try{self.postMessage({status:"Updating Categories and List"});if(!db)await IDBinit();const{updateRecommendedMediaList,mediaFilters,mediaCautions,categoriesToEdit,entriesToHide,entriesToShow}=data||{};let shouldReloadAllCategories=updateRecommendedMediaList;const messageToPost={updateDate:new Date,postId:postId,updateRecommendedMediaList:updateRecommendedMediaList};const userList=await retrieveJSON("userList")||getDefaultUserList();if(mediaCautions instanceof Array){messageToPost.updateUserList=messageToPost.updateMediaCautions=shouldReloadAllCategories=true;userList.mediaCautions=mediaCautions}if(!jsonIsEmpty(entriesToShow)||!jsonIsEmpty(entriesToHide)){messageToPost.updateUserList=shouldReloadAllCategories=true;if(entriesToShow["all"]){userList.hiddenEntries={}}else{for(let id in entriesToShow){delete userList.hiddenEntries[id]}for(let id in entriesToHide){userList.hiddenEntries[id]=true}}}if(categoriesToEdit instanceof Array&&categoriesToEdit.length>0){messageToPost.updateUserList=true;messageToPost.updatedCategories={};for(let i=0;i<categoriesToEdit.length;i++){const action=categoriesToEdit[i];if(action?.add){for(const categoryToAddKey in action.add){const categoryToAddFromKey=action.add[categoryToAddKey];const categoryToAddFrom=userList.categories[categoryToAddFromKey];if(categoryToAddFrom!=null){userList.categories[categoryToAddKey]=JSON.parse(JSON.stringify(categoryToAddFrom));messageToPost.updatedCategories[categoryToAddKey]=true}}}else if(action?.rename){for(const newNameForCategory in action.rename){const categoryToBeRenamedKey=action.rename[newNameForCategory];const categoryToBeRenamed=userList.categories[categoryToBeRenamedKey];if(categoryToBeRenamed!=null){userList.categories[newNameForCategory]=JSON.parse(JSON.stringify(categoryToBeRenamed));delete userList.categories[categoryToBeRenamedKey];messageToPost.updatedCategories[newNameForCategory]=true}if(mediaFilters[categoryToBeRenamedKey]!=null){mediaFilters[newNameForCategory]=JSON.parse(JSON.stringify(mediaFilters[categoryToBeRenamedKey]));delete mediaFilters[categoryToBeRenamedKey]}}}else if(action?.delete){const categoryToDeleteKey=action.delete;delete userList.categories[categoryToDeleteKey];delete mediaFilters[categoryToDeleteKey]}}}if(shouldReloadAllCategories||!jsonIsEmpty(mediaFilters)){messageToPost.updateUserList=true;recommendedMediaList=await retrieveJSON("recommendedMediaList");if(recommendedMediaList!=null){const categories=userList.categories;cautions=getContentCaution(userList.mediaCautions);recommendedMediaListArray=Object.values(recommendedMediaList);hiddenEntries=userList.hiddenEntries;if(shouldReloadAllCategories){const categoriesCount=Object.keys(categories||{}).length;let loadedCount=0;for(const categoryKey in categories){const category=categories[categoryKey];if(category!=null){userList.categories[categoryKey]=updateMediaList(mediaFilters?.[categoryKey]?.mediaFilters||category.mediaFilters,mediaFilters?.[categoryKey]?.sortBy||category.sortBy,Math.min(1,loadedCount/categoriesCount));loadedCount++}}}else{const categoriesCount=Object.keys(mediaFilters||{}).length;let loadedCount=0;for(const categoryKey in mediaFilters){const category=categories[categoryKey];const mediaFilter=mediaFilters[categoryKey];if(category!=null){userList.categories[categoryKey]=updateMediaList(mediaFilter.mediaFilters||category.mediaFilters,mediaFilter.sortBy||category.sortBy,Math.min(1,loadedCount/categoriesCount));loadedCount++}}}}self.postMessage({progress:85});await saveJSONCollection({userList:userList,shouldLoadMedia:false})}else if(messageToPost.updateUserList){self.postMessage({progress:85});await saveJSON(userList,"userList")}self.postMessage({progress:95});self.postMessage(messageToPost)}catch(reason){console.error(reason);let error=reason?.stack||reason?.message;if(typeof error!=="string"||!error){error="Something went wrong"}self.postMessage({error:error,postId:postId})}};function getContentCaution(mediaCautions){let semiContentCautions={genres:{},tags:{}},cautionContents={genres:{},tags:{}};for(let i=0,l=mediaCautions?.length;i<l;i++){let{status,filterType,optionName,optionCategory}=mediaCautions[i]||{};if(status==="included"){if(filterType==="selection"){if(optionCategory==="genre"){semiContentCautions.genres[optionName]=true}else if(optionCategory==="tag"){semiContentCautions.tags[optionName]=true}}}else if(status==="excluded"){if(filterType==="selection"){if(optionCategory==="genre"){cautionContents.genres[optionName]=true}else if(optionCategory==="tag"){cautionContents.tags[optionName]=true}}}}return{semiContentCautions:semiContentCautions,cautionContents:cautionContents}}function updateMediaList(mediaFilters,sortBy,loadedPercent=1){let flexibleInclusion={genreTagStudio:false,genreTag:false,genreStudio:false,tagStudio:false,genres:false,tags:false,studios:false},include={genres:{},tags:{},season:{},sequentialSeason:{},format:{},countryOfOrigin:{},status:{},userStatus:{},studios:{},year:{},shownList:{}},exclude={genres:{},tags:{},season:{},sequentialSeason:{},format:{},countryOfOrigin:{},status:{},userStatus:{},studios:{},year:{},shownList:{}},comparisonFilter={weightedScore:null,score:null,averageScore:null,userScore:null,popularity:null,year:null},shownSortName,animeIncluded;let showHiddenList=false,hideMyList=false,hideMyFinishedList=false,showMyList=false,showAllSequels=false,showUserUnseenSequel=false,showAnimeAdapted=false,hasUnseenProgress=false;const{semiContentCautions,cautionContents}=cautions;for(let i=0,l=mediaFilters?.length;i<l;i++){let{status,filterType,optionName,optionCategory,optionValue,CMPOperator,CMPNumber}=mediaFilters[i]||{};if(status==="included"){if(filterType==="selection"){if(optionCategory==="shown metric"){shownSortName=optionName}else if(optionCategory==="flexible inclusion"){if(optionName==="OR: genre / tag / studio"){flexibleInclusion.genreTagStudio=true}else if(optionName==="OR: genre / tag"){flexibleInclusion.genreTag=true}else if(optionName==="OR: genre / studio"){flexibleInclusion.genreStudio=true}else if(optionName==="OR: tag / studio"){flexibleInclusion.tagStudio=true}else if(optionName==="OR: genre"){flexibleInclusion.genres=true}else if(optionName==="OR: tag"){flexibleInclusion.tags=true}else if(optionName==="OR: studio"){flexibleInclusion.studios=true}}else if(optionCategory==="shown list"){include.shownList[optionName]=true}else if(optionCategory==="genre"){include.genres[optionName]=true}else if(optionCategory==="tag"){include.tags[optionName]=true}else if(optionCategory==="year"){include.year[optionName]=true}else if(optionCategory==="season"){let lowerOptionName=optionName;if(lowerOptionName==="current season"||lowerOptionName==="next season"||lowerOptionName==="previous season"||lowerOptionName==="ongoing seasons"||lowerOptionName==="future seasons"||lowerOptionName==="past seasons"){hasNonBaselineIncludedSeason=true;include.sequentialSeason[lowerOptionName]=true}else{include.season[lowerOptionName]=true}}else if(optionCategory==="format"){if(optionName==="Anime"){animeIncluded=true}else{include.format[optionName]=true}}else if(optionCategory==="country of origin"){include.countryOfOrigin[optionName]=true}else if(optionCategory==="release status"){include.status[optionName]=true}else if(optionCategory==="user status"){include.userStatus[optionName]=true}else if(optionCategory==="studio"){include.studios[optionName]=true}}else if(filterType==="bool"){if(optionName==="hide my list"){hideMyList=true}else if(optionName==="hide my finished list"){hideMyFinishedList=true}else if(optionName==="show my list"){showMyList=true}else if(optionName==="show all sequels"){showAllSequels=true}else if(optionName==="show next sequel"){showUserUnseenSequel=true}else if(optionName==="show anime adapted"){showAnimeAdapted=true}else if(optionName==="has unseen progress"){hasUnseenProgress=true}else if(optionName==="hidden list"){showHiddenList=true}}else if(filterType==="number"){if(optionName==="weighted score"){comparisonFilter.weightedScore={operator:CMPOperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName==="score"){comparisonFilter.score={operator:CMPOperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName==="average score"){comparisonFilter.averageScore={operator:CMPOperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName==="user score"){comparisonFilter.userScore={operator:CMPOperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName==="popularity"){comparisonFilter.popularity={operator:CMPOperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName==="year"){comparisonFilter.year={operator:CMPOperator,value:parseFloat(CMPNumber??optionValue)}}}}else if(status==="excluded"){if(filterType==="selection"){if(optionCategory==="shown list"){exclude.shownList[optionName]=true}else if(optionCategory==="genre"){exclude.genres[optionName]=true}else if(optionCategory==="tag"){exclude.tags[optionName]=true}else if(optionCategory==="year"){exclude.year[optionName]=true}else if(optionCategory==="season"){let lowerOptionName=optionName;if(lowerOptionName==="current season"||lowerOptionName==="next season"||lowerOptionName==="previous season"||lowerOptionName==="ongoing seasons"||lowerOptionName==="future seasons"||lowerOptionName==="past seasons"){exclude.sequentialSeason[lowerOptionName]=true}else{exclude.season[lowerOptionName]=true}}else if(optionCategory==="format"){if(optionName==="Anime"){animeIncluded=false}else{exclude.format[optionName]=true}}else if(optionCategory==="country of origin"){exclude.countryOfOrigin[optionName]=true}else if(optionCategory==="release status"){exclude.status[optionName]=true}else if(optionCategory==="user status"){exclude.userStatus[optionName]=true}else if(optionCategory==="studio"){exclude.studios[optionName]=true}}}}let hasFilter={genres:{include:!jsonIsEmpty(include.genres),exclude:!jsonIsEmpty(exclude.genres)},tags:{include:!jsonIsEmpty(include.tags),exclude:!jsonIsEmpty(exclude.tags)},season:{include:!jsonIsEmpty(include.season),exclude:!jsonIsEmpty(exclude.season)},sequentialSeason:{include:!jsonIsEmpty(include.sequentialSeason),exclude:!jsonIsEmpty(exclude.sequentialSeason)},format:{include:!jsonIsEmpty(include.format),exclude:!jsonIsEmpty(exclude.format)},countryOfOrigin:{include:!jsonIsEmpty(include.countryOfOrigin),exclude:!jsonIsEmpty(exclude.countryOfOrigin)},status:{include:!jsonIsEmpty(include.status),exclude:!jsonIsEmpty(exclude.status)},userStatus:{include:!jsonIsEmpty(include.userStatus),exclude:!jsonIsEmpty(exclude.userStatus)},studios:{include:!jsonIsEmpty(include.studios),exclude:!jsonIsEmpty(exclude.studios)},year:{include:!jsonIsEmpty(include.year),exclude:!jsonIsEmpty(exclude.year)},shownList:{include:!jsonIsEmpty(include.shownList),exclude:!jsonIsEmpty(exclude.shownList)},flexibleInclusion:{combinedGenres:flexibleInclusion.genreTagStudio||flexibleInclusion.genreStudio||flexibleInclusion.genreTag,combinedTags:flexibleInclusion.genreTagStudio||flexibleInclusion.genreTag||flexibleInclusion.tagStudio,combinedStudios:flexibleInclusion.genreTagStudio||flexibleInclusion.genreStudio||flexibleInclusion.tagStudio},cautionContents:{genres:!jsonIsEmpty(cautionContents.genres),tags:!jsonIsEmpty(cautionContents.tags)},semiContentCautions:{genres:!jsonIsEmpty(semiContentCautions.genres),tags:!jsonIsEmpty(semiContentCautions.tags)}};let recommendedMediaListArrayLen=recommendedMediaListArray.length;let mediaList=recommendedMediaListArray.filter((media,idx)=>{loadProgress(Math.min((idx+1)/recommendedMediaListArrayLen*loadedPercent*100,80));if(hideMyList){if(media?.userStatus!=="Unseen"){return false}}if(showMyList){if(typeof media?.userStatus!=="string"||media.userStatus==="Unseen"){return false}}if(showHiddenList){if(hiddenEntries?.[media?.id]===undefined){return false}}else{if(hiddenEntries[media?.id]){return false}}if(hideMyFinishedList){let userStatus=media?.userStatus;if(userStatus==="Completed"||userStatus==="Dropped"){return false}}let entryMightBeAnime;if(hasUnseenProgress){if(media?.userStatus==="Completed"||media?.status==="Not Yet Released"){return false}else{let currentProgress,releasedProgress,entryIsFinished=media?.status==="Finished",format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel";if(entryMightBeAnime){currentProgress=media?.episodeProgress;if(entryIsFinished){releasedProgress=media?.episodes}if(!(releasedProgress>0)){const nextAiringEpisode=media?.nextAiringEpisode;if(nextAiringEpisode?.estimated===true)return false;const nextEpisodeIsAired=nextAiringEpisode?.airingAt*1e3<=(new Date).getTime();const airingEpisode=nextAiringEpisode?.episode??1;releasedProgress=nextEpisodeIsAired?airingEpisode:airingEpisode-1}}else{if(entryIsFinished){currentProgress=media?.episodeProgress;releasedProgress=media?.chapters;if(!(releasedProgress>0&&currentProgress>0)){currentProgress=media?.volumeProgress;releasedProgress=media?.volumes}}}if(typeof releasedProgress!=="number"||isNaN(releasedProgress)||!isFinite(releasedProgress)||(currentProgress||0)>=releasedProgress){return false}}}if(comparisonFilter.userScore){let operator=comparisonFilter.userScore.operator,value=comparisonFilter.userScore.value;if(typeof media?.userScore!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(media.userScore<value)return false;break}case"<=":{if(media.userScore>value)return false;break}case"<":{if(media.userScore>=value)return false;break}case">":{if(media.userScore<=value)return false;break}}}else if(media.userScore!==value){return false}}}if(comparisonFilter.averageScore){let operator=comparisonFilter.averageScore.operator,value=comparisonFilter.averageScore.value;if(typeof media?.averageScore!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(media.averageScore<value)return false;break}case"<=":{if(media.averageScore>value)return false;break}case"<":{if(media.averageScore>=value)return false;break}case">":{if(media.averageScore<=value)return false;break}}}else if(media.averageScore!==value){return false}}}if(comparisonFilter.popularity){let operator=comparisonFilter.popularity.operator,value=comparisonFilter.popularity.value;if(typeof media?.popularity!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(media.popularity<value)return false;break}case"<=":{if(media.popularity>value)return false;break}case"<":{if(media.popularity>=value)return false;break}case">":{if(media.popularity<=value)return false;break}}}else if(media.popularity!==value){return false}}}if(comparisonFilter.weightedScore){let operator=comparisonFilter.weightedScore.operator,value=comparisonFilter.weightedScore.value;if(typeof media?.weightedScore!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(media.weightedScore<value)return false;break}case"<=":{if(media.weightedScore>value)return false;break}case"<":{if(media.weightedScore>=value)return false;break}case">":{if(media.weightedScore<=value)return false;break}}}else if(media.weightedScore!==value){return false}}}if(comparisonFilter.score){let operator=comparisonFilter.score.operator,value=comparisonFilter.score.value;if(typeof media?.score!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(media.score<value)return false;break}case"<=":{if(media.score>value)return false;break}case"<":{if(media.score>=value)return false;break}case">":{if(media.score<=value)return false;break}}}else if(media.score!==value){return false}}}if(comparisonFilter.year){if(media?.year==null)return false;let year=parseInt(media?.year);if(isNaN(year))return false;let operator=comparisonFilter.year.operator,value=comparisonFilter.year.value;if(typeof year!=="number"){return false}else if(typeof value==="number"){if(typeof operator==="string"){switch(operator){case">=":{if(year<value)return false;break}case"<=":{if(year>value)return false;break}case"<":{if(year>=value)return false;break}case">":{if(year<=value)return false;break}}}else if(year!==value){return false}}}if(animeIncluded===false){if(typeof media?.format==="string"){let format=media.format;let entryIsAnime=format==="TV"||format==="Movie"||format==="ONA"||format==="Special"||format==="TV Short"||format==="OVA";if(entryIsAnime){return false}}}if(typeof media?.format==="string"&&exclude.format[media.format]){return false}if(typeof media?.countryOfOrigin==="string"&&exclude.countryOfOrigin[media.countryOfOrigin]){return false}if(typeof media?.userStatus==="string"&&exclude.userStatus[media.userStatus]){return false}if(typeof media?.status==="string"&&exclude.status[media.status]){return false}if(media?.year!=null&&exclude.year[media?.year?.toString()]){return false}if(typeof media?.season==="string"&&exclude.season[media.season]){return false}if(hasFilter.sequentialSeason.exclude){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}let season=media?.season;let hasSeason=season==="Winter"||season==="Spring"||season==="Summer"||season==="Fall";if(entryMightBeAnime||hasSeason){if(exclude.sequentialSeason["current season"]||exclude.sequentialSeason["next season"]||exclude.sequentialSeason["previous season"]||exclude.sequentialSeason["ongoing seasons"]||exclude.sequentialSeason["future seasons"]||exclude.sequentialSeason["past seasons"]){let year=parseInt(media?.year);if(!isNaN(year)){let currentSeasonYear=getCurrentSeasonYear()||{};if(hasSeason){const seasonYear=`${season} ${year}`;if((exclude.sequentialSeason["current season"]||exclude.sequentialSeason["ongoing seasons"])&&seasonYear===currentSeasonYear.seasonYear){return false}if((exclude.sequentialSeason["next season"]||exclude.sequentialSeason["future seasons"])&&seasonYear===currentSeasonYear.nextSeasonYear){return false}if((exclude.sequentialSeason["previous season"]||exclude.sequentialSeason["past seasons"])&&seasonYear===currentSeasonYear.previousSeasonYear){return false}}if((exclude.sequentialSeason["ongoing seasons"]||exclude.sequentialSeason["past seasons"])&&(year<currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.pastSeasonsInCurrentYear?.[season])){if(exclude.sequentialSeason["past seasons"]){return false}else if(typeof media?.status==="string"){let status=media.status;if(status==="Releasing"||status==="Not Yet Released"){return false}}}if(exclude.sequentialSeason["future seasons"]&&(year>currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.futureSeasonsInCurrentYear?.[season])){return false}}}}}let studioArray;if(hasFilter.shownList.exclude){if(exclude.shownList["recommended studios"]){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}if(entryMightBeAnime&&isJsonObject(media?.favoriteContents?.studios)&&!jsonIsEmpty(media.favoriteContents.studios)){studioArray=Object.keys(media.studios||{});if(studioArray.some(studio=>typeof studio==="string"&&media.favoriteContents.studios[studio])){return false}}}if(exclude.shownList["non-caution"]){if(hasFilter.cautionContents.genres&&!media?.genres?.some(genre=>typeof genre==="string"&&cautionContents.genres[genre])||hasFilter.cautionContents.tags&&!media?.tags?.some(tag=>typeof tag?.name==="string"&&cautionContents.tags[tag.name])){return false}}if(exclude.shownList["non-semi-caution"]){if(hasFilter.semiContentCautions.genres&&!media?.genres?.some(genre=>typeof genre==="string"&&semiContentCautions.genres[genre])||hasFilter.semiContentCautions.tags&&!media?.tags?.some(tag=>typeof tag?.name==="string"&&semiContentCautions.tags[tag.name])){return false}}if(exclude.shownList["recommended score"]||exclude.shownList["semi-recommended score"]||exclude.shownList["other"]){if(typeof media?.score!=="number"){return false}if(exclude.shownList["recommended score"]){if(typeof media?.meanScoreAbove!=="number")return false;if(media.score>=media.meanScoreAbove)return false}if(exclude.shownList["semi-recommended score"]){if(typeof media?.meanScoreAll!=="number"||typeof media?.meanScoreAbove!=="number")return false;if(media.score<media.meanScoreAbove&&media.score>=media.meanScoreAll)return false}if(exclude.shownList["other"]){if(typeof media.meanScoreAll!=="number")return false;if(media.score<media.meanScoreAll)return false}}}if(hasFilter.genres.exclude){if(media?.genres?.some(genre=>typeof genre==="string"&&exclude.genres[genre]))return false}if(hasFilter.tags.exclude){if(media?.tags?.some(tag=>typeof tag?.name==="string"&&exclude.tags[tag.name]))return false}if(hasFilter.studios.exclude){studioArray=studioArray||Object.keys(media.studios||{});if(studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&exclude.studios[studio])){return false}}}if(hasFilter.shownList.include){if(include.shownList["recommended studios"]){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}studioArray=studioArray||Object.keys(media.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(isJsonObject(media?.favoriteContents?.studios)){if(jsonIsEmpty(media.favoriteContents.studios))return false;if(!studioArray.some(studio=>typeof studio==="string"&&media.favoriteContents.studios[studio])){return false}}}}if(include.shownList["non-caution"]){if(media?.genres?.some(genre=>typeof genre==="string"&&cautionContents.genres[genre]))return false;if(media?.tags?.some(tag=>typeof tag?.name==="string"&&cautionContents.tags[tag.name]))return false}if(include.shownList["non-semi-caution"]){if(media?.genres?.some(genre=>typeof genre==="string"&&semiContentCautions.genres[genre]))return false;if(media?.tags?.some(tag=>typeof tag?.name==="string"&&semiContentCautions.tags[tag.name]))return false}if(include.shownList["recommended score"]||include.shownList["semi-recommended score"]||include.shownList["other"]){if(typeof media?.score!=="number"){return false}if(include.shownList["recommended score"]&&include.shownList["semi-recommended score"]){if(typeof media?.meanScoreAll!=="number")return false;if(media.score<media.meanScoreAll)return false}else if(include.shownList["recommended score"]&&include.shownList["other"]){if(typeof media?.meanScoreAll!=="number"||typeof media?.meanScoreAbove!=="number")return false;if(media.score<media.meanScoreAbove&&media.score>=media.meanScoreAll)return false}else if(include.shownList["semi-recommended score"]&&include.shownList["other"]){if(typeof media?.meanScoreAbove!=="number")return false;if(media.score>=media.meanScoreAbove)return false}else if(include.shownList["recommended score"]){if(typeof media?.meanScoreAbove!=="number")return false;if(media.score<media.meanScoreAbove)return false}else if(include.shownList["semi-recommended score"]){if(typeof media?.meanScoreAll!=="number"||typeof media?.meanScoreAbove!=="number")return false;if(media.score>=media.meanScoreAbove||media.score<media.meanScoreAll)return false}else if(include.shownList["other"]){if(typeof media?.meanScoreAll!=="number")return false;if(media.score>=media.meanScoreAll)return false}}}if(hasFilter.sequentialSeason.include){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}let season=media?.season;let hasSeason=season==="Winter"||season==="Spring"||season==="Summer"||season==="Fall";if(entryMightBeAnime||hasSeason){if(include.sequentialSeason["current season"]||include.sequentialSeason["next season"]||include.sequentialSeason["previous season"]||include.sequentialSeason["ongoing seasons"]||include.sequentialSeason["future seasons"]||include.sequentialSeason["past seasons"]){let isNotIncluded;do{let year=parseInt(media?.year);if(!isNaN(year)){let currentSeasonYear=getCurrentSeasonYear()||{};if(hasSeason){const seasonYear=`${season} ${year}`;if((include.sequentialSeason["current season"]||include.sequentialSeason["ongoing seasons"])&&seasonYear===currentSeasonYear.seasonYear){break}if((include.sequentialSeason["next season"]||include.sequentialSeason["future seasons"])&&seasonYear===currentSeasonYear.nextSeasonYear){break}if((include.sequentialSeason["previous season"]||include.sequentialSeason["past seasons"])&&seasonYear===currentSeasonYear.previousSeasonYear){break}}if((include.sequentialSeason["ongoing seasons"]||include.sequentialSeason["past seasons"])&&(year<currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.pastSeasonsInCurrentYear?.[season])){if(include.sequentialSeason["past seasons"]){break}else if(typeof media?.status==="string"){let status=media?.status;if(status==="Releasing"||status==="Not Yet Released"){break}}}if(include.sequentialSeason["future seasons"]&&(year>currentSeasonYear.year||year===currentSeasonYear.year&&currentSeasonYear.futureSeasonsInCurrentYear?.[season])){break}}isNotIncluded=true;break}while(false);if(isNotIncluded){return false}}}}if(hasFilter.season.include){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}let season=media?.season;let hasSeason=season==="Winter"||season==="Spring"||season==="Summer"||season==="Fall";if(entryMightBeAnime||hasSeason){if(!include.season[season]){return false}}}if(animeIncluded===true){if(typeof media?.format==="string"){let format=media.format;if(format==="Manga"&&!include.format.Manga||format==="One Shot"&&!include.format["One Shot"]||format==="Novel"&&!include.format.Novel){return false}}}else if(hasFilter.format.include){if(typeof media?.format!=="string"||!include.format[media.format]){return false}}if(hasFilter.countryOfOrigin.include){if(typeof media?.countryOfOrigin!=="string"||!include.countryOfOrigin[media.countryOfOrigin]){return false}}if(hasFilter.userStatus.include){if(typeof media?.userStatus!=="string"||!include.userStatus[media.userStatus]){return false}}if(hasFilter.status.include){if(typeof media?.status!=="string"||!include.status[media.status]){return false}}if(hasFilter.year.include){if(media?.year==null||!include.year[media?.year?.toString?.()]){return false}}if(flexibleInclusion.genreTagStudio){let isNotIncluded;do{if(!hasFilter.genres.include&&!hasFilter.tags.include&&!hasFilter.studios.include){break}if(hasFilter.genres.include&&media?.genres?.some?.(genre=>typeof genre==="string"&&include.genres[genre])){break}if(hasFilter.tags.include&&media?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name])){break}if(hasFilter.studios.include){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}studioArray=studioArray||Object.keys(media?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&include.studios[studio])){break}}else{break}}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}else if(flexibleInclusion.genreTag){let isNotIncluded;do{if(!hasFilter.genres.include&&!hasFilter.tags.include){break}if(hasFilter.genres.include&&media?.genres?.some?.(genre=>typeof genre==="string"&&include.genres[genre])){break}if(hasFilter.tags.include&&media?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name])){break}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}else if(flexibleInclusion.genreStudio){let isNotIncluded;do{if(!hasFilter.genres.include&&!hasFilter.studios.include){break}if(hasFilter.genres.include&&media?.genres?.some?.(genre=>typeof genre==="string"&&include.genres[genre])){break}if(hasFilter.studios.include){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}studioArray=studioArray||Object.keys(media?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&include.studios[studio])){break}}else{break}}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}else if(flexibleInclusion.tagStudio){let isNotIncluded;do{if(!hasFilter.tags.include&&!hasFilter.studios.include){break}if(hasFilter.tags.include&&media?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name])){break}if(hasFilter.studios.include){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}studioArray=studioArray||Object.keys(media?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(studioArray.some(studio=>typeof studio==="string"&&include.studios[studio])){break}}else{break}}isNotIncluded=true;break}while(false);if(isNotIncluded)return false}if(!hasFilter.flexibleInclusion.combinedGenres&&hasFilter.genres.include){if(flexibleInclusion.genres){if(!media?.genres?.some(genre=>typeof genre==="string"&&include.genres[genre])){return false}}else{for(let genre in include.genres){if(!media?.genres?.some(g=>typeof g==="string"&&g===genre)){return false}}}}if(!hasFilter.flexibleInclusion.combinedTags&&hasFilter.tags.include){if(flexibleInclusion.tags){if(!media?.tags?.some(tag=>typeof tag?.name==="string"&&include.tags[tag.name])){return false}}else{for(let tag in include.tags){if(!media?.tags?.some(t=>typeof t?.name==="string"&&t.name===tag)){return false}}}}if(!hasFilter.flexibleInclusion.combinedStudios&&hasFilter.studios.include){if(entryMightBeAnime==null){let format=media?.format;entryMightBeAnime=format!=="Manga"&&format!=="One Shot"&&format!=="Novel"}studioArray=studioArray||Object.keys(media?.studios||{});if(entryMightBeAnime||studioArray?.length>0){if(flexibleInclusion.studios){if(!studioArray.some(studio=>typeof studio==="string"&&include.studios[studio]))return false}else{for(let studio in include.studios){if(!studioArray.some(s=>typeof s==="string"&&s===studio)){return false}}}}}let mediaRelations=media?.mediaRelations;if(mediaRelations instanceof Array){if(showUserUnseenSequel){let userStatus=media?.userStatus;let isNotUserMediaUnseenSequel=userStatus==="Completed"||userStatus==="Repeating"||userStatus==="Dropped"||!mediaRelations.some(e=>{if(e?.relationType?.toLowerCase?.()==="prequel"){let mediaRelationID=e?.node?.id;if(mediaRelationID!=null){mediaRelationID=Math.floor(mediaRelationID);let relationMedia=recommendedMediaList[mediaRelationID];let relationStatus=relationMedia?.userStatus;return relationStatus==="Completed"||relationStatus==="Repeating"}}});if(isNotUserMediaUnseenSequel){return false}}if(!showAllSequels){let isUnseenSequel=!mediaRelations.some(e=>e?.relationType?.toLowerCase?.()==="prequel")||mediaRelations.some(e=>{if(e?.relationType?.toLowerCase?.()==="prequel"){let mediaRelationID=e?.node?.id;if(mediaRelationID!=null){mediaRelationID=Math.floor(mediaRelationID);let relationMedia=recommendedMediaList[mediaRelationID];let relationStatus=relationMedia?.userStatus;if(relationStatus!=="Unseen"&&relationStatus!=="Dropped"){return true}else{return e?.node?.popularity<media?.popularity}}}});if(!isUnseenSequel){return false}}if(!showAnimeAdapted){let format=media?.format;if(format==="Manga"||format==="One Shot"||format==="Novel"){let hasAnimeAdaptation=mediaRelations.some(e=>{let mediaRelationType=e?.relationType?.toLowerCase?.();if(mediaRelationType==="adaptation"||mediaRelationType==="alternative"){let mediaRelationID=e?.node?.id;if(mediaRelationID!=null){mediaRelationID=Math.floor(mediaRelationID);let relationMedia=recommendedMediaList[mediaRelationID];let relationFormat=relationMedia?.format;let possibleAnime=relationFormat!=="Manga"&&relationFormat!=="One Shot"&&relationFormat!=="Novel";if(possibleAnime){let relationStatus=relationMedia?.status;return relationStatus==="Finished"||relationStatus==="Releasing"||relationStatus==="Not Yet Released"}}}});if(hasAnimeAdaptation){return false}}}}return true});let sortType=sortBy?.sortType||"desc";let sortName=sortBy?.sortName||"weighted score";if(sortType==="desc"){if(sortName==="weighted score"){mediaList.sort((a,b)=>{let x=a?.weightedScore!=null?a.weightedScore:-Infinity,y=b?.weightedScore!=null?b.weightedScore:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;return y-x})}else if(sortName==="score"){mediaList.sort((a,b)=>{let x=a?.score!=null?a.score:-Infinity,y=b?.score!=null?b.score:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;return y-x})}else if(sortName==="average score"){mediaList.sort((a,b)=>{let x=a?.averageScore!=null?a.averageScore:-Infinity,y=b?.averageScore!=null?b.averageScore:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="user score"){mediaList.sort((a,b)=>{let x=a?.userScore!=null?a.userScore:-Infinity,y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;if(x!==y)return y-x;x=a?.averageScore!=null?a.averageScore:-Infinity;y=b?.averageScore!=null?b.averageScore:-Infinity;return y-x})}else if(sortName==="popularity"){mediaList.sort((a,b)=>{let x=a?.popularity!=null?a.popularity:-Infinity,y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.favorites!=null?a.favorites:-Infinity;y=b?.favorites!=null?b.favorites:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="trending"){mediaList.sort((a,b)=>{let x=a?.trending!=null?a.trending:-Infinity,y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.favorites!=null?a.favorites:-Infinity;y=b?.favorites!=null?b.favorites:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="favorites"){mediaList.sort((a,b)=>{let x=a?.favorites!=null?a.favorites:-Infinity,y=b?.favorites!=null?b.favorites:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.averageScore!=null?a.averageScore:-Infinity;y=b?.averageScore!=null?b.averageScore:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="date updated"){mediaList.sort((a,b)=>{let x=a?.dateEdited||a?.dateAdded?Math.max(a?.dateEdited||0,a?.dateAdded||0):-Infinity,y=b?.dateEdited||b?.dateAdded?Math.max(b?.dateEdited||0,b?.dateAdded||0):-Infinity;if(x!==y)return y-x;let year=a?.year;let season=a?.season;let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season;startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=dateA!=null?dateA:-Infinity;y=dateB!=null?dateB:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="date added"){mediaList.sort((a,b)=>{let x=a?.id!=null?parseInt(a?.id):-Infinity,y=b?.id!=null?parseInt(b?.id):-Infinity;if(x!==y)return y-x;x=a?.dateAdded?a?.dateAdded:-Infinity;y=b?.dateAdded?b?.dateAdded:-Infinity;if(x!==y)return y-x;let year=a?.year;let season=a?.season;let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season;startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=dateA!=null?dateA:-Infinity;y=dateB!=null?dateB:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}else if(sortName==="date"){mediaList.sort((a,b)=>{let year=a?.year;let season=a?.season;let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season;startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();let x=dateA!=null?dateA:-Infinity;let y=dateB!=null?dateB:-Infinity;if(x!==y)return y-x;x=a?.userScore!=null?a.userScore:-Infinity;y=b?.userScore!=null?b.userScore:-Infinity;if(x!==y)return y-x;x=a?.trending!=null?a.trending:-Infinity;y=b?.trending!=null?b.trending:-Infinity;if(x!==y)return y-x;x=a?.popularity!=null?a.popularity:-Infinity;y=b?.popularity!=null?b.popularity:-Infinity;if(x!==y)return y-x;x=a?.score!=null?a.score:-Infinity;y=b?.score!=null?b.score:-Infinity;return y-x})}}else if(sortType==="asc"){if(sortName==="weighted score"){mediaList.sort((a,b)=>{let x=a?.weightedScore!=null?a?.weightedScore:Infinity,y=b?.weightedScore!=null?b?.weightedScore:Infinity;return x-y})}else if(sortName==="score"){mediaList.sort((a,b)=>{let x=a?.score!=null?a?.score:Infinity,y=b?.score!=null?b?.score:Infinity;return x-y})}else if(sortName==="average score"){mediaList.sort((a,b)=>{let x=a?.averageScore!=null?a?.averageScore:Infinity,y=b?.averageScore!=null?b?.averageScore:Infinity;return x-y})}else if(sortName==="user score"){mediaList.sort((a,b)=>{let x=a?.userScore!=null?a?.userScore:Infinity,y=b?.userScore!=null?b?.userScore:Infinity;return x-y})}else if(sortName==="popularity"){mediaList.sort((a,b)=>{let x=a?.popularity!=null?a?.popularity:Infinity,y=b?.popularity!=null?b?.popularity:Infinity;return x-y})}else if(sortName==="trending"){mediaList.sort((a,b)=>{let x=a?.trending!=null?a?.trending:Infinity,y=b?.trending!=null?b?.trending:Infinity;if(x!==y)return x-y;x=a?.popularity!=null?a.popularity:Infinity;y=b?.popularity!=null?b.popularity:Infinity;return x-y})}else if(sortName==="favorites"){mediaList.sort((a,b)=>{let x=a?.favorites!=null?a?.favorites:Infinity,y=b?.favorites!=null?b?.favorites:Infinity;if(x!==y)return x-y;x=a?.popularity!=null?a.popularity:Infinity;y=b?.popularity!=null?b.popularity:Infinity;return x-y})}else if(sortName==="date updated"){mediaList.sort((a,b)=>{let x=a?.dateEdited||a?.dateAdded?Math.max(a?.dateEdited||0,a?.dateAdded||0):Infinity,y=b?.dateEdited||b?.dateAdded?Math.max(b?.dateEdited||0,b?.dateAdded||0):Infinity;if(x!==y)return x-y;let year=a?.year;let season=a?.season;let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;x=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season;startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;y=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=x!=null?x:Infinity;y=y!=null?y:Infinity;return x-y})}else if(sortName==="date added"){mediaList.sort((a,b)=>{let x=a?.id!=null?parseInt(a?.id):Infinity,y=b?.id!=null?parseInt(b?.id):Infinity;if(x!==y)return x-y;x=a?.dateAdded?a?.dateAdded:Infinity;y=b?.dateAdded?b?.dateAdded:Infinity;if(x!==y)return x-y;let year=a?.year;let season=a?.season;let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;x=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season;startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;y=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();x=x!=null?x:Infinity;y=y!=null?y:Infinity;return x-y})}else if(sortName==="date"){mediaList.sort((a,b)=>{let year=a?.year;let season=a?.season;let startDate=a?.startDate||{};let month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}let day=startDate?.day;let dateA=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();year=b?.year;season=b?.season;startDate=b?.startDate||{};month=startDate?.month;if(parseInt(month)>0){month=parseInt(month)-1}day=startDate?.day;let dateB=getJapaneseStartDate({season:season,year:year,month:month,day:day})?.getTime?.();let x=dateA!=null?dateA:Infinity;let y=dateB!=null?dateB:Infinity;return x-y})}}return{mediaList:mediaList.map(({id})=>id),isHiddenList:showHiddenList,shownSortName:shownSortName||sortName,mediaFilters:mediaFilters,sortBy:sortBy}}function getCurrentSeasonYear(){let currentDate=new Date;let year=currentDate.getFullYear();let seasons={Winter:new Date(parseInt(year),0,1),Spring:new Date(parseInt(year),3,1),Summer:new Date(parseInt(year),6,1),Fall:new Date(parseInt(year),9,1)};if(isNaN(year))return null;if(currentDate<seasons.Spring){return{year:year,seasonYear:`Winter ${year}`,nextSeasonYear:`Spring ${year}`,previousSeasonYear:`Fall ${year-1}`,futureSeasonsInCurrentYear:{Spring:true,Summer:true,Fall:true},pastSeasonsInCurrentYear:{}}}else if(currentDate>=seasons.Spring&&currentDate<seasons.Summer){return{year:year,seasonYear:`Spring ${year}`,nextSeasonYear:`Summer ${year}`,previousSeasonYear:`Winter ${year}`,futureSeasonsInCurrentYear:{Summer:true,Fall:true},pastSeasonsInCurrentYear:{Winter:true}}}else if(currentDate>=seasons.Summer&&currentDate<seasons.Fall){return{year:year,seasonYear:`Summer ${year}`,nextSeasonYear:`Fall ${year}`,previousSeasonYear:`Spring ${year}`,futureSeasonsInCurrentYear:{Fall:true},pastSeasonsInCurrentYear:{Winter:true,Spring:true}}}else{return{year:year,seasonYear:`Fall ${year}`,nextSeasonYear:`Winter ${year+1}`,previousSeasonYear:`Summer ${year}`,futureSeasonsInCurrentYear:{},pastSeasonsInCurrentYear:{Winter:true,Spring:true,Summer:true}}}}function getJapaneseStartDate({season,year,month,day}){if(parseInt(year)>=0){if(parseInt(month)>=0){return new Date(parseInt(year),parseInt(month),parseInt(day||1)||1)}const seasonKey=season?.trim();if(seasonKey&&(seasonKey==="Winter"||seasonKey==="Spring"||seasonKey==="Summer"||seasonKey==="Fall")&&!isNaN(year)){let seasons={Winter:new Date(parseInt(year),0,1),Spring:new Date(parseInt(year),3,1),Summer:new Date(parseInt(year),6,1),Fall:new Date(parseInt(year),9,1)};return seasons[seasonKey]}return new Date(parseInt(year),0,1)}else{return null}}function msToTime(duration,limit){try{if(duration<1e3){return"0s"}let seconds=Math.floor(duration/1e3%60),minutes=Math.floor(duration/6e4%60),hours=Math.floor(duration/36e5%24),days=Math.floor(duration/864e5%7),weeks=Math.floor(duration/6048e5%4),months=Math.floor(duration/24192e5%12),years=Math.floor(duration/290304e5%10),decades=Math.floor(duration/290304e6%10),century=Math.floor(duration/290304e7%10),millenium=Math.floor(duration/290304e8%10);let time=[];if(millenium>0)time.push(`${millenium}mil`);if(century>0)time.push(`${century}cen`);if(decades>0)time.push(`${decades}dec`);if(years>0)time.push(`${years}y`);if(months>0)time.push(`${months}mon`);if(weeks>0)time.push(`${weeks}w`);if(days>0)time.push(`${days}d`);if(hours>0)time.push(`${hours}h`);if(minutes>0)time.push(`${minutes}m`);if(seconds>0)time.push(`${seconds}s`);if(limit>0){time=time.slice(0,limit)}return time.join(" ")||"0s"}catch(e){return""}}function IDBinit(){return new Promise(resolve=>{let request=indexedDB.open("Kanshi.Media.Recommendations.Anilist.W~uPtWCq=vG$TR:Zl^#t<vdS]I~N70",1);request.onsuccess=event=>{db=event.target.result;resolve()};request.onupgradeneeded=event=>{db=event.target.result;db.createObjectStore("others");event.target.transaction.oncomplete=()=>{resolve()}};request.onerror=error=>{console.error(error)}})}function saveJSON(data,name){return new Promise((resolve,reject)=>{let blob,transaction;try{transaction=db.transaction("others","readwrite");let store=transaction.objectStore("others");let put;transaction.oncomplete=()=>{resolve()};if(data instanceof Blob){blob=data;put=store.put(blob,name)}else if(isJsonObject(data)||data instanceof Array){blob=new Blob([JSON.stringify(data)]);put=store.put(blob,name)}else{put=store.put(data,name)}put.onerror=ex=>{transaction.oncomplete=undefined;if(blob instanceof Blob){(async()=>{try{await saveJSON((new FileReaderSync).readAsArrayBuffer(blob),name);resolve()}catch(ex2){console.error(ex);console.error(ex2);reject(ex)}})()}else{console.error(ex);reject(ex)}};try{transaction?.commit?.()}catch{}}catch(ex){if(transaction?.oncomplete){transaction.oncomplete=undefined}if(blob instanceof Blob){(async()=>{try{await saveJSON((new FileReaderSync).readAsArrayBuffer(blob),name);resolve()}catch(ex2){console.error(ex);console.error(ex2);reject(ex)}})()}else{console.error(ex);reject(ex)}}})}function saveJSONCollection(collection){return new Promise((resolve,reject)=>{try{let transaction=db.transaction("others","readwrite");let store=transaction.objectStore("others");let put;transaction.oncomplete=()=>{resolve()};for(let key in collection){let data=collection[key];let blob;if(data instanceof Blob){blob=data;put=store.put(blob,key)}else if(isJsonObject(data)||data instanceof Array){blob=new Blob([JSON.stringify(data)]);put=store.put(blob,key)}else{put=store.put(data,key)}put.onerror=ex=>{transaction.oncomplete=undefined;if(blob instanceof Blob){try{transaction.oncomplete=()=>{resolve()};put=store.put((new FileReaderSync).readAsArrayBuffer(blob),key);put.onerror=ex=>{console.error(ex);reject(ex)};try{transaction?.commit?.()}catch{}}catch(ex2){console.error(ex);console.error(ex2);reject(ex2)}}else{console.error(ex);reject(ex)}}}try{transaction?.commit?.()}catch{}}catch(ex){console.error(ex);reject(ex)}})}function retrieveJSON(name){return new Promise(resolve=>{try{let get=db.transaction("others","readonly").objectStore("others").get(name);get.onsuccess=()=>{let result=get.result;if(result instanceof Blob){result=JSON.parse((new FileReaderSync).readAsText(result))}else if(result instanceof ArrayBuffer){result=JSON.parse((new TextDecoder).decode(result))}resolve(result)};get.onerror=ex=>{console.error(ex);resolve()}}catch(ex){console.error(ex);resolve()}})}function jsonIsEmpty(obj){for(const key in obj){return false}return true}function isJsonObject(obj){return Object.prototype.toString.call(obj)==="[object Object]"}function getDefaultUserList(){let defaultCategories=["   Completed Anime","   Completed Manga","   Completed Novel","  Airing & Upcoming","  Ongoing Manga","  Ongoing Novel"," Next Sequel in My List","Anticipated","My List","Recently Updated"];return{hiddenEntries:{},mediaCautions:[{optionName:"Netorare",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"Rape",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"Prostitution",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"Ero Guro",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"Suicide",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"Slavery",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"Tragedy",optionCategory:"tag",status:"excluded",filterType:"selection"},{optionName:"Ecchi",optionCategory:"genre",status:"included",filterType:"selection"},{optionName:"Nudity",optionCategory:"tag",status:"included",filterType:"selection"}],categories:defaultCategories.reduce((acc,addedCategory)=>{let isUserRelated=addedCategory===" Next Sequel in My List"||addedCategory==="My List";let sortName,shownSortName;if(isUserRelated){sortName="score"}else if(addedCategory==="Anticipated"){sortName="popularity"}else if(addedCategory==="Recently Updated"){sortName="date updated"}else{sortName="weighted score"}switch(addedCategory){case"   Completed Anime":{mediaFilters=[{optionName:"Finished",optionCategory:"release status",status:"included",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"},{optionName:"Anime",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case"   Completed Manga":{mediaFilters=[{optionName:"Finished",optionCategory:"release status",status:"included",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"},{optionName:"Anime",optionCategory:"format",status:"excluded",filterType:"selection"},{optionName:"Novel",optionCategory:"format",status:"excluded",filterType:"selection"}];shownSortName="average score";break}case"   Completed Novel":{mediaFilters=[{optionName:"Finished",optionCategory:"release status",status:"included",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"},{optionName:"Novel",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case"  Airing & Upcoming":{mediaFilters=[{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"Releasing",optionCategory:"release status",status:"included",filterType:"selection"},{optionName:"Not Yet Released",optionCategory:"release status",status:"included",filterType:"selection"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"},{optionName:"Anime",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case"  Ongoing Manga":{mediaFilters=[{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"Releasing",optionCategory:"release status",status:"included",filterType:"selection"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"},{optionName:"Anime",optionCategory:"format",status:"excluded",filterType:"selection"},{optionName:"Novel",optionCategory:"format",status:"excluded",filterType:"selection"}];shownSortName="average score";break}case"  Ongoing Novel":{mediaFilters=[{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"Releasing",optionCategory:"release status",status:"included",filterType:"selection"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"},{optionName:"Novel",optionCategory:"format",status:"included",filterType:"selection"}];shownSortName="average score";break}case" Next Sequel in My List":{mediaFilters=[{optionName:"Finished",optionCategory:"release status",status:"none",filterType:"selection"},{optionName:"hide my list",filterType:"bool",status:"included"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"show next sequel",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"}];shownSortName="average score";break}case"Anticipated":{mediaFilters=[{optionName:"hide my list",status:"included",filterType:"bool"},{optionName:"hide my finished list",status:"included",filterType:"bool"},{optionName:"Not Yet Released",optionCategory:"release status",status:"included",filterType:"selection"}];break}case"My List":{mediaFilters=[{optionName:"Finished",optionCategory:"release status",status:"none",filterType:"selection"},{optionName:"Repeating",optionCategory:"user status",status:"none",filterType:"selection"},{optionName:"hide my finished list",filterType:"bool",status:"included"},{optionName:"show my list",filterType:"bool",status:"included"},{optionName:"average score",optionCategory:"shown metric",status:"included",filterType:"selection"}];shownSortName="average score";break}case"Recently Updated":{mediaFilters=[{optionName:"show all sequels",filterType:"bool",status:"included"},{optionName:"score",optionCategory:"shown metric",status:"included",filterType:"selection"}];shownSortName="score";break}}acc[addedCategory]={isHiddenList:false,shownSortName:shownSortName||sortName,sortBy:{sortName:sortName,sortType:"desc"},mediaFilters:mediaFilters};return acc},{})}}let startPost=performance.now();function loadProgress(progress){let endPost=performance.now();if(endPost-startPost>17){self.postMessage({progress:progress});startPost=endPost}}